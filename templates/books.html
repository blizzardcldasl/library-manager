{% extends "base.html" %}
{% block title %}Books Library - Library Manager{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
        <i class="bi bi-collection"></i>
        Books Library
    </h2>
    <div>
        <span class="text-muted">{{ total_books }} total book{{ 's' if total_books != 1 else '' }}</span>
    </div>
</div>

<!-- Search and Filters -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" action="/books" id="filter-form">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Search</label>
                    <div class="input-group">
                        <input type="text" class="form-control bg-dark text-light" name="search" 
                               id="live-search-input"
                               value="{{ search }}" placeholder="Author, title, or path..."
                               onkeyup="liveFilter(this.value)">
                        <button class="btn btn-outline-secondary" type="submit">
                            <i class="bi bi-search"></i>
                        </button>
                        {% if search %}
                        <a href="/books?status={{ status_filter }}&sort={{ sort_by }}&order={{ sort_order }}" 
                           class="btn btn-outline-secondary" title="Clear search">
                            <i class="bi bi-x"></i>
                        </a>
                        {% endif %}
                    </div>
                    <small class="text-muted"><span id="filter-count">{{ books|length }}</span> shown</small>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Quick Select</label>
                    <select class="form-select bg-dark text-light" id="books-quick-select" onchange="applyBooksQuickSelect()">
                        <option value="">-- Select All Matching --</option>
                        <option value="same_author">Same Author</option>
                        <option value="same_status">Same Status</option>
                        <option value="errors">Errors Only</option>
                        <option value="pending">Pending Items</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Select by Pattern</label>
                    <div class="input-group">
                        <input type="text" class="form-control bg-dark text-light" id="books-pattern-select" 
                               placeholder="e.g., 'Boyett'">
                        <button class="btn btn-outline-primary" type="button" onclick="selectBooksByPattern()">
                            <i class="bi bi-funnel"></i> Select
                        </button>
                    </div>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Status</label>
                    <select class="form-select bg-dark text-light" name="status" onchange="this.form.submit()">
                        <option value="">All Statuses</option>
                        <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>
                            Pending ({{ status_counts.get('pending', 0) }})
                        </option>
                        <option value="fixed" {% if status_filter == 'fixed' %}selected{% endif %}>
                            Fixed ({{ status_counts.get('fixed', 0) }})
                        </option>
                        <option value="verified" {% if status_filter == 'verified' %}selected{% endif %}>
                            Verified ({{ status_counts.get('verified', 0) }})
                        </option>
                        <option value="pending_fix" {% if status_filter == 'pending_fix' %}selected{% endif %}>
                            Pending Fix ({{ status_counts.get('pending_fix', 0) }})
                        </option>
                        <option value="error" {% if status_filter == 'error' %}selected{% endif %}>
                            Error ({{ status_counts.get('error', 0) }})
                        </option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Sort By</label>
                    <select class="form-select bg-dark text-light" name="sort" onchange="this.form.submit()">
                        <option value="updated_at" {% if sort_by == 'updated_at' %}selected{% endif %}>Last Updated</option>
                        <option value="current_author" {% if sort_by == 'current_author' %}selected{% endif %}>Author</option>
                        <option value="current_title" {% if sort_by == 'current_title' %}selected{% endif %}>Title</option>
                        <option value="status" {% if sort_by == 'status' %}selected{% endif %}>Status</option>
                        <option value="created_at" {% if sort_by == 'created_at' %}selected{% endif %}>Created</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Order</label>
                    <select class="form-select bg-dark text-light" name="order" onchange="this.form.submit()">
                        <option value="desc" {% if sort_order == 'desc' %}selected{% endif %}>Descending</option>
                        <option value="asc" {% if sort_order == 'asc' %}selected{% endif %}>Ascending</option>
                    </select>
                </div>
                <div class="col-md-1">
                    <label class="form-label">Per Page</label>
                    <select class="form-select bg-dark text-light" name="per_page" onchange="this.form.submit()">
                        <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
                        <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                        <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
                        <option value="200" {% if per_page == 200 %}selected{% endif %}>200</option>
                    </select>
                </div>
            </div>
            <input type="hidden" name="page" value="1">
        </form>
    </div>
</div>

{% if books %}
<style>
    .resizable-table th { resize: horizontal; overflow: auto; min-width: 60px; }
    .resizable-table td { word-break: break-word; }
    .book-path { font-size: 0.85rem; color: #6c757d; }
</style>
<div class="card">
    <div class="card-body p-0" style="max-height: 700px; overflow: auto;">
        <table class="table table-sm mb-0 resizable-table table-hover" style="table-layout: auto;">
            <thead style="position: sticky; top: 0; background: rgba(22, 33, 62, 0.98); z-index: 10;">
                <tr>
                    <th style="width: 25%;">Author</th>
                    <th style="width: 30%;">Title</th>
                    <th style="width: 30%;">Path</th>
                    <th style="width: 100px;">Status</th>
                    <th style="width: 120px;">Updated</th>
                    <th style="width: 80px;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for book in books %}
                <tr>
                    <td>
                        <strong class="text-info">{{ book.current_author or 'Unknown' }}</strong>
                    </td>
                    <td>
                        <span class="text-light">{{ book.current_title or 'Untitled' }}</span>
                    </td>
                    <td>
                        <span class="book-path" title="{{ book.path }}">
                            {% set path_parts = book.path.split('/') %}
                            {% if path_parts|length > 3 %}
                                .../{{ '/'.join(path_parts[-3:]) }}
                            {% else %}
                                {{ book.path }}
                            {% endif %}
                        </span>
                    </td>
                    <td>
                        {% if book.status == 'fixed' %}
                        <span class="badge bg-success" 
                              data-bs-toggle="tooltip" 
                              title="Book has been fixed and folder renamed">
                            Fixed
                        </span>
                        {% elif book.status == 'verified' %}
                        <span class="badge bg-info" 
                              data-bs-toggle="tooltip" 
                              title="Book structure verified as correct">
                            Verified
                        </span>
                        {% elif book.status == 'pending_fix' %}
                        <span class="badge bg-warning text-dark" 
                              data-bs-toggle="tooltip" 
                              title="Fix is pending. Go to History to apply it.">
                            Pending Fix
                        </span>
                        {% elif book.status == 'error' %}
                        <span class="badge bg-danger" 
                              data-bs-toggle="tooltip" 
                              data-bs-html="true"
                              title="<strong>Error:</strong> {{ (book.error_message or 'Unknown error') | e }}<br><br>Click Edit to fix the metadata.">
                            Error <i class="bi bi-info-circle"></i>
                        </span>
                        {% else %}
                        <span class="badge bg-secondary" 
                              data-bs-toggle="tooltip" 
                              title="Book is pending analysis">
                            Pending
                        </span>
                        {% endif %}
                    </td>
                    <td>
                        <small class="text-muted">
                            {% if book.updated_at %}
                                {{ book.updated_at[5:16] if book.updated_at|length > 16 else book.updated_at }}
                            {% else %}
                                -
                            {% endif %}
                        </small>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-outline-info btn-sm" 
                                    onclick="viewBookDetails({{ book.id }})" 
                                    title="View details">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-outline-primary btn-sm" 
                                    onclick="editBook({{ book.id }}, '{{ book.current_author|replace("'", "\\'") }}', '{{ book.current_title|replace("'", "\\'") }}', '{{ book.path|replace("'", "\\'") }}')" 
                                    title="Edit/Fix metadata">
                                <i class="bi bi-pencil"></i>
                            </button>
                            {% if book.status == 'pending_fix' %}
                            <a href="/history?status=pending" class="btn btn-outline-warning btn-sm" 
                               title="View pending fix">
                                <i class="bi bi-hourglass-split"></i>
                            </a>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Pagination -->
{% if total_pages > 1 %}
{% set filter_params = [] %}
{% if search %}{% set _ = filter_params.append('search=' + search|urlencode) %}{% endif %}
{% if status_filter %}{% set _ = filter_params.append('status=' + status_filter) %}{% endif %}
{% if sort_by %}{% set _ = filter_params.append('sort=' + sort_by) %}{% endif %}
{% if sort_order %}{% set _ = filter_params.append('order=' + sort_order) %}{% endif %}
{% if per_page %}{% set _ = filter_params.append('per_page=' + per_page|string) %}{% endif %}
{% set filter_string = '&' + filter_params|join('&') if filter_params else '' %}
<nav class="mt-4">
    <ul class="pagination justify-content-center">
        {% if page > 1 %}
        <li class="page-item">
            <a class="page-link" href="?page={{ page - 1 }}{{ filter_string }}">&laquo; Previous</a>
        </li>
        {% endif %}

        {% for p in range(1, total_pages + 1) %}
        {% if p == page %}
        <li class="page-item active"><span class="page-link">{{ p }}</span></li>
        {% elif p <= 3 or p >= total_pages - 2 or (p >= page - 2 and p <= page + 2) %}
        <li class="page-item"><a class="page-link" href="?page={{ p }}{{ filter_string }}">{{ p }}</a></li>
        {% elif p == 4 or p == total_pages - 3 %}
        <li class="page-item disabled"><span class="page-link">...</span></li>
        {% endif %}
        {% endfor %}

        {% if page < total_pages %}
        <li class="page-item">
            <a class="page-link" href="?page={{ page + 1 }}{{ filter_string }}">Next &raquo;</a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

{% else %}
<div class="card">
    <div class="card-body text-center py-5">
        <i class="bi bi-journal-x text-muted" style="font-size: 4rem;"></i>
        <h4 class="mt-3">No books found</h4>
        <p class="text-muted">
            {% if search or status_filter %}
            Try adjusting your search or filter criteria.
            {% else %}
            Run a library scan to discover books.
            {% endif %}
        </p>
        {% if search or status_filter %}
        <a href="/books" class="btn btn-primary">Clear Filters</a>
        {% else %}
        <a href="/" class="btn btn-primary">Go to Dashboard</a>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Book Details Modal -->
<div class="modal fade" id="bookDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title">Book Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="book-details-content">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Book Modal -->
<div class="modal fade" id="editBookModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-pencil"></i> Edit Book Metadata</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-book-id">

                <!-- Current Path Display -->
                <div class="alert alert-info mb-3">
                    <div class="d-flex align-items-start">
                        <i class="bi bi-folder me-2 mt-1"></i>
                        <div class="flex-grow-1">
                            <strong>Current Path:</strong><br>
                            <code class="text-light small" id="edit-book-current-path" style="word-break: break-all;">Loading...</code>
                        </div>
                    </div>
                </div>

                <!-- Tabbed Interface -->
                <ul class="nav nav-tabs mb-3" id="bookMetadataTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="book-manual-tab" data-bs-toggle="tab" data-bs-target="#book-manual-pane" type="button" role="tab">
                            <i class="bi bi-pencil-square"></i> Manual Entry
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="book-asin-tab" data-bs-toggle="tab" data-bs-target="#book-asin-pane" type="button" role="tab">
                            <i class="bi bi-upc"></i> ASIN Lookup
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="book-search-tab" data-bs-toggle="tab" data-bs-target="#book-search-pane" type="button" role="tab">
                            <i class="bi bi-search"></i> Search APIs
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="book-quick-match-tab" data-bs-toggle="tab" data-bs-target="#book-quick-match-pane" type="button" role="tab">
                            <i class="bi bi-lightning"></i> Quick Match
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="bookMetadataTabContent">
                    <!-- Manual Entry Tab -->
                    <div class="tab-pane fade show active" id="book-manual-pane" role="tabpanel">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label"><i class="bi bi-person"></i> Author</label>
                                <input type="text" class="form-control bg-dark text-light" id="edit-book-author" placeholder="Author Name">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label"><i class="bi bi-book"></i> Title</label>
                                <input type="text" class="form-control bg-dark text-light" id="edit-book-title" placeholder="Book Title">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label"><i class="bi bi-collection"></i> Series</label>
                                <input type="text" class="form-control bg-dark text-light" id="edit-book-series" placeholder="Series Name (optional)">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label"><i class="bi bi-hash"></i> Series Position</label>
                                <input type="text" class="form-control bg-dark text-light" id="edit-book-series-position" placeholder="1, 2, 3... (optional)">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label"><i class="bi bi-mic"></i> Narrator</label>
                                <input type="text" class="form-control bg-dark text-light" id="edit-book-narrator" placeholder="Narrator (optional)">
                            </div>
                        </div>
                        <div class="alert alert-secondary">
                            <small><i class="bi bi-info-circle"></i> Enter metadata manually or use other tabs to search for it.</small>
                        </div>
                    </div>

                    <!-- ASIN Lookup Tab -->
                    <div class="tab-pane fade" id="book-asin-pane" role="tabpanel">
                        <div class="mb-3">
                            <label class="form-label"><i class="bi bi-upc"></i> Audible ASIN Lookup</label>
                            <div class="input-group mb-2">
                                <input type="text" class="form-control bg-dark text-light" id="edit-audnexus-asin" placeholder="Enter ASIN (e.g., B002V5H8FK)" maxlength="10" style="text-transform: uppercase;">
                                <select class="form-select bg-dark text-light" id="edit-audnexus-region" style="max-width: 120px;">
                                    <option value="us">ðŸ‡ºðŸ‡¸ US</option>
                                    <option value="uk">ðŸ‡¬ðŸ‡§ UK</option>
                                    <option value="au">ðŸ‡¦ðŸ‡º AU</option>
                                    <option value="ca">ðŸ‡¨ðŸ‡¦ CA</option>
                                    <option value="de">ðŸ‡©ðŸ‡ª DE</option>
                                    <option value="es">ðŸ‡ªðŸ‡¸ ES</option>
                                    <option value="fr">ðŸ‡«ðŸ‡· FR</option>
                                    <option value="in">ðŸ‡®ðŸ‡³ IN</option>
                                    <option value="it">ðŸ‡®ðŸ‡¹ IT</option>
                                    <option value="jp">ðŸ‡¯ðŸ‡µ JP</option>
                                </select>
                                <button class="btn btn-primary" type="button" onclick="searchAudnexusASINForBook()" id="edit-search-audnexus-btn">
                                    <i class="bi bi-search"></i> Lookup
                                </button>
                            </div>
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i> Searches AudiMeta (faster) and Audnexus. Enter 10-character Audible ASIN.
                            </small>
                        </div>

                        <!-- ASIN Result -->
                        <div id="edit-audnexus-result" class="mb-3" style="display: none;">
                            <div id="edit-audnexus-result-content"></div>
                        </div>
                    </div>

                    <!-- Search APIs Tab -->
                    <div class="tab-pane fade" id="book-search-pane" role="tabpanel">
                        <div class="mb-3">
                            <label class="form-label"><i class="bi bi-search"></i> Search All Metadata Sources</label>
                            <div class="input-group mb-2">
                                <input type="text" class="form-control bg-dark text-light" id="edit-search-query" placeholder="Search by title or author...">
                                <button class="btn btn-primary" type="button" onclick="searchAllAPIsForBook()" id="edit-search-all-apis-btn">
                                    <i class="bi bi-search"></i> Search All
                                </button>
                                <button class="btn btn-outline-info" type="button" onclick="searchBookDBForBook()" id="edit-search-bookbucket-btn" title="Search only BookBucket">
                                    <i class="bi bi-database"></i> BookBucket
                                </button>
                            </div>
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i> Searches: AudiMeta, OpenLibrary, Google Books, Hardcover, and BookBucket
                            </small>
                        </div>

                        <!-- Search Status -->
                        <div id="edit-search-status" class="mb-2 d-none">
                            <div class="d-flex align-items-center">
                                <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                                <small class="text-muted" id="edit-search-status-text">Searching APIs...</small>
                            </div>
                        </div>

                        <!-- Search Results -->
                        <div id="edit-search-results" class="mb-3" style="max-height: 450px; overflow-y: auto; display: none;">
                            <div id="edit-search-results-list">
                                <!-- Results inserted here - grouped by source -->
                            </div>
                        </div>
                    </div>

                    <!-- Quick Match Tab -->
                    <div class="tab-pane fade" id="book-quick-match-pane" role="tabpanel">
                        <div class="alert alert-warning mb-3">
                            <i class="bi bi-lightning-fill"></i> <strong>Quick Match</strong> automatically finds and selects the best match from all metadata sources.
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Search Query</label>
                            <div class="input-group">
                                <input type="text" class="form-control bg-dark text-light" id="edit-quick-match-query" placeholder="Enter book title or author...">
                                <button class="btn btn-primary" type="button" onclick="quickMatchForBook()" id="edit-quick-match-btn">
                                    <i class="bi bi-lightning"></i> Quick Match
                                </button>
                            </div>
                            <small class="text-muted">Searches all providers and auto-selects the best match if confidence is high enough.</small>
                        </div>
                        <div id="edit-quick-match-result" style="display: none;">
                            <div id="edit-quick-match-result-content"></div>
                        </div>
                    </div>
                </div>

                <!-- Selected Match Display -->
                <div id="edit-selected-match" class="alert alert-success d-none mt-3">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <strong><i class="bi bi-check-circle"></i> Selected Match:</strong><br>
                            <span id="edit-selected-match-text"></span>
                        </div>
                        <button type="button" class="btn-close" onclick="clearBookSelection()" aria-label="Clear selection"></button>
                    </div>
                </div>

                <!-- Field Selection (when match selected) -->
                <div id="edit-field-selection" class="card bg-secondary bg-opacity-25 mt-3 d-none">
                    <div class="card-header">
                        <small><i class="bi bi-check2-square"></i> Select fields to import:</small>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="edit-field-author" checked>
                                    <label class="form-check-label" for="edit-field-author">Author</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="edit-field-title" checked>
                                    <label class="form-check-label" for="edit-field-title">Title</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="edit-field-series">
                                    <label class="form-check-label" for="edit-field-series">Series Name</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="edit-field-series-position">
                                    <label class="form-check-label" for="edit-field-series-position">Series Position</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="edit-field-narrator">
                                    <label class="form-check-label" for="edit-field-narrator">Narrator</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="edit-field-year">
                                    <label class="form-check-label" for="edit-field-year">Year</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="edit-field-description">
                                    <label class="form-check-label" for="edit-field-description">Description</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="edit-field-cover">
                                    <label class="form-check-label" for="edit-field-cover">Cover Art</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Path Preview -->
                <div id="edit-path-preview" class="alert alert-info d-none mt-3">
                    <strong><i class="bi bi-eye"></i> Preview:</strong><br>
                    <div class="row mt-2">
                        <div class="col-md-6">
                            <small class="text-muted">Current:</small><br>
                            <code class="text-danger small" id="edit-preview-old-path" style="word-break: break-all;"></code>
                        </div>
                        <div class="col-md-6">
                            <small class="text-muted">New:</small><br>
                            <code class="text-success small" id="edit-preview-new-path" style="word-break: break-all;"></code>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-outline-primary" onclick="saveBookFixAsPending()">
                    <i class="bi bi-save"></i> Save as Pending
                </button>
                <button type="button" class="btn btn-primary" onclick="applyBookFixDirectly()" id="edit-apply-directly-btn">
                    <i class="bi bi-check-lg"></i> Apply Now
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function viewBookDetails(bookId) {
    const modal = new bootstrap.Modal(document.getElementById('bookDetailsModal'));
    const content = document.getElementById('book-details-content');
    
    content.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
    modal.show();
    
    fetch(`/api/book/${bookId}`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const book = data.book;
                let html = `
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Author:</strong><br>
                            <span class="text-info">${escapeHtml(book.current_author || 'Unknown')}</span>
                        </div>
                        <div class="col-md-6">
                            <strong>Title:</strong><br>
                            <span class="text-light">${escapeHtml(book.current_title || 'Untitled')}</span>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-12">
                            <strong>Path:</strong><br>
                            <code class="text-muted small">${escapeHtml(book.path || 'N/A')}</code>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Status:</strong><br>
                            ${getStatusBadge(book.status)}
                        </div>
                        <div class="col-md-6">
                            <strong>Created:</strong><br>
                            <small class="text-muted">${book.created_at || 'N/A'}</small>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Last Updated:</strong><br>
                            <small class="text-muted">${book.updated_at || 'N/A'}</small>
                        </div>
                    </div>
                `;
                
                if (book.error_message) {
                    html += `
                        <div class="alert alert-danger">
                            <strong>Error:</strong><br>
                            <small>${escapeHtml(book.error_message)}</small>
                        </div>
                    `;
                }
                
                content.innerHTML = html;
            } else {
                content.innerHTML = `<div class="alert alert-danger">${escapeHtml(data.error || 'Failed to load book details')}</div>`;
            }
        })
        .catch(e => {
            content.innerHTML = `<div class="alert alert-danger">Error loading details: ${escapeHtml(e.message)}</div>`;
        });
}

function getStatusBadge(status) {
    const badges = {
        'fixed': '<span class="badge bg-success">Fixed</span>',
        'verified': '<span class="badge bg-info">Verified</span>',
        'pending_fix': '<span class="badge bg-warning text-dark">Pending Fix</span>',
        'error': '<span class="badge bg-danger">Error</span>',
        'pending': '<span class="badge bg-secondary">Pending</span>'
    };
    return badges[status] || '<span class="badge bg-secondary">' + escapeHtml(status) + '</span>';
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Quick actions
function quickApplyBook(bookId) {
    // This would need to fetch the pending fix for this book and apply it
    // For now, just show a message
    if (confirm('Apply the pending fix for this book?')) {
        // Fetch pending fix and apply
        fetch(`/api/book/${bookId}`)
            .then(r => r.json())
            .then(data => {
                if (data.success && data.book.status === 'pending_fix') {
                    // Find the pending fix in history and apply it
                    fetch('/api/history?status=pending_fix&book_id=' + bookId)
                        .then(r => r.json())
                        .then(histData => {
                            if (histData.success && histData.items && histData.items.length > 0) {
                                const fixId = histData.items[0].id;
                                fetch(`/api/apply_fix/${fixId}`, {method: 'POST'})
                                    .then(r => r.json())
                                    .then(applyData => {
                                        if (applyData.success) {
                                            showSuccess('Fix applied!', 'Applied');
                                            setTimeout(() => location.reload(), 1000);
                                        } else {
                                            showErrorWithHelp(applyData.message || 'Failed to apply', 'file');
                                        }
                                    });
                            } else {
                                showWarning('No pending fix found for this book');
                            }
                        });
                } else {
                    showWarning('This book does not have a pending fix');
                }
            });
    }
}

// Real-time filtering
function liveFilter(query) {
    const rows = document.querySelectorAll('tbody tr');
    const lowerQuery = query.toLowerCase();
    let visibleCount = 0;
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        if (text.includes(lowerQuery)) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    // Update count
    const countEl = document.getElementById('filter-count');
    if (countEl) {
        countEl.textContent = visibleCount;
    }
}

// Smart bulk selection for books
function applyBooksQuickSelect() {
    const select = document.getElementById('books-quick-select');
    const value = select.value;
    if (!value) return;
    
    // Note: Books page doesn't have checkboxes by default, this is for future use
    // For now, just highlight matching rows
    const rows = Array.from(document.querySelectorAll('tbody tr'));
    
    rows.forEach(row => {
        if (row.style.display === 'none') return;
        
        const text = row.textContent;
        let shouldHighlight = false;
        
        switch(value) {
            case 'same_author':
                // This would require more complex logic - skip for now
                break;
            case 'same_status':
                // This would require status comparison - skip for now
                break;
            case 'errors':
                shouldHighlight = text.includes('Error') || text.includes('error');
                break;
            case 'pending':
                shouldHighlight = text.includes('Pending') || text.includes('pending');
                break;
        }
        
        if (shouldHighlight) {
            row.style.backgroundColor = 'rgba(255, 193, 7, 0.1)';
        } else {
            row.style.backgroundColor = '';
        }
    });
}

function selectBooksByPattern() {
    const pattern = document.getElementById('books-pattern-select').value.trim();
    if (!pattern) return;
    
    const rows = document.querySelectorAll('tbody tr');
    rows.forEach(row => {
        if (row.style.display === 'none') return;
        const text = row.textContent;
        if (text.includes(pattern)) {
            row.style.backgroundColor = 'rgba(255, 193, 7, 0.1)';
        } else {
            row.style.backgroundColor = '';
        }
    });
}

// Auto-submit search on Enter
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.querySelector('input[name="search"]');
    if (searchInput) {
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('filter-form').submit();
            }
        });
    }
});

// ===== BOOK EDIT/FIX FUNCTIONALITY =====
let selectedBookMetadata = null;
let editBookModal = null;

function editBook(bookId, currentAuthor, currentTitle, currentPath) {
    document.getElementById('edit-book-id').value = bookId;
    document.getElementById('edit-book-author').value = currentAuthor || '';
    document.getElementById('edit-book-title').value = currentTitle || '';
    document.getElementById('edit-book-current-path').textContent = currentPath || 'Unknown';
    document.getElementById('edit-search-query').value = currentTitle || '';  // Pre-fill search with title
    document.getElementById('edit-quick-match-query').value = currentTitle || '';  // Pre-fill quick match
    document.getElementById('edit-search-results').style.display = 'none';
    document.getElementById('edit-selected-match').classList.add('d-none');
    document.getElementById('edit-field-selection').classList.add('d-none');
    document.getElementById('edit-audnexus-result').style.display = 'none';
    document.getElementById('edit-quick-match-result').style.display = 'none';
    selectedBookMetadata = null;
    window._audnexusResultForBook = null;
    
    // Reset field selection checkboxes
    const fieldChecks = ['edit-field-author', 'edit-field-title', 'edit-field-series', 'edit-field-series-position', 'edit-field-narrator', 'edit-field-year', 'edit-field-description', 'edit-field-cover'];
    fieldChecks.forEach(id => {
        const checkbox = document.getElementById(id);
        if (checkbox) {
            checkbox.checked = (id === 'edit-field-author' || id === 'edit-field-title');
        }
    });
    
    // Switch to manual tab
    const manualTab = document.getElementById('book-manual-tab');
    if (manualTab) {
        manualTab.click();
    }
    document.getElementById('edit-path-preview').classList.add('d-none');
    selectedBookMetadata = null;

    if (!editBookModal) {
        editBookModal = new bootstrap.Modal(document.getElementById('editBookModal'));
    }
    editBookModal.show();
    
    // Update preview when fields change
    const authorInput = document.getElementById('edit-book-author');
    const titleInput = document.getElementById('edit-book-title');
    authorInput.addEventListener('input', updateBookPathPreview);
    titleInput.addEventListener('input', updateBookPathPreview);
}

function updateBookPathPreview() {
    const author = document.getElementById('edit-book-author').value.trim();
    const title = document.getElementById('edit-book-title').value.trim();
    const currentPath = document.getElementById('edit-book-current-path').textContent;
    const previewDiv = document.getElementById('edit-path-preview');
    
    if (!author || !title) {
        previewDiv.classList.add('d-none');
        return;
    }
    
    // Show current path
    document.getElementById('edit-preview-old-path').textContent = currentPath;
    
    // Simple preview
    const simplePreview = `${author}/${title}`;
    document.getElementById('edit-preview-new-path').textContent = simplePreview + ' (preview)';
    previewDiv.classList.remove('d-none');
}

function saveBookFixAsPending() {
    saveBookFix();
}

function applyBookFixDirectly() {
    const bookId = document.getElementById('edit-book-id').value;
    const author = document.getElementById('edit-book-author').value.trim();
    const title = document.getElementById('edit-book-title').value.trim();
    
    if (!author || !title) {
        showWarning('Author and title are required.', 'Required Fields');
        return;
    }
    
    const currentPath = document.getElementById('edit-book-current-path').textContent;
    
    // Show preview
    document.getElementById('edit-preview-old-path').textContent = currentPath;
    document.getElementById('edit-preview-new-path').textContent = `${author}/${title}`;
    document.getElementById('edit-path-preview').classList.remove('d-none');
    
    // Confirm with preview
    if (!confirm(`Apply this fix now?\n\nCurrent: ${currentPath}\nNew: ${author}/${title}\n\nThe folder will be renamed immediately.`)) {
        return;
    }
    
    const btn = document.getElementById('edit-apply-directly-btn');
    const originalHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Applying...';
    
    const payload = {
        book_id: parseInt(bookId),
        author: author,
        title: title
    };
    
    // Include metadata result if one was selected
    if (selectedBookMetadata) {
        payload.metadata_result = selectedBookMetadata;
    } else if (window._audnexusResult) {
        payload.metadata_result = window._audnexusResult;
    }
    
    fetch('/api/apply_fix_direct', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(data => {
        btn.disabled = false;
        btn.innerHTML = originalHtml;
        
        if (data.success) {
            showSuccess('Fix applied successfully!', 'Applied');
            if (editBookModal) editBookModal.hide();
            setTimeout(() => location.reload(), 1000);
        } else {
            showErrorWithHelp(data.error || 'Unknown error', 'file');
        }
    })
    .catch(e => {
        btn.disabled = false;
        btn.innerHTML = originalHtml;
        showErrorWithHelp('Error: ' + e, 'api');
    });
}

function searchAllAPIsForBook() {
    const query = document.getElementById('edit-search-query').value.trim();
    const author = document.getElementById('edit-book-author').value.trim();
    
    if (!query || query.length < 2) {
        showWarning('Please enter at least 2 characters to search.', 'Search Too Short');
        return;
    }

    const statusDiv = document.getElementById('edit-search-status');
    const statusText = document.getElementById('edit-search-status-text');
    const resultsDiv = document.getElementById('edit-search-results');
    const resultsList = document.getElementById('edit-search-results-list');
    const btn = document.getElementById('edit-search-all-apis-btn');

    statusDiv.classList.remove('d-none');
    statusText.textContent = 'Searching all metadata sources...';
    resultsDiv.style.display = 'none';
    resultsList.innerHTML = '';
    btn.disabled = true;

    let url = `/api/search_all_apis?q=${encodeURIComponent(query)}`;
    if (author) {
        url += `&author=${encodeURIComponent(author)}`;
    }

    fetch(url)
        .then(r => r.json())
        .then(data => {
            statusDiv.classList.add('d-none');
            btn.disabled = false;

            if (data.error) {
                showErrorWithHelp(data.error, 'api');
                return;
            }

            const resultsBySource = data.results_by_source || {};
            const totalCount = data.total_count || 0;

            if (totalCount === 0) {
                resultsList.innerHTML = '<div class="alert alert-info">No results found. Try a different search term.</div>';
                resultsDiv.style.display = 'block';
                return;
            }

            let html = `<div class="mb-2"><small class="text-muted">Found ${totalCount} result(s) from ${Object.keys(resultsBySource).length} source(s)</small></div>`;

            for (const [source, results] of Object.entries(resultsBySource)) {
                html += `<div class="mb-3"><h6 class="text-info">${source}</h6>`;
                results.forEach((result, idx) => {
                    const seriesText = result.series && result.series_position 
                        ? ` <small class="text-warning">(${result.series} #${result.series_position})</small>` 
                        : '';
                    html += `
                        <div class="card bg-secondary bg-opacity-25 mb-2" style="cursor: pointer;" 
                             onclick="selectBookMetadata(${JSON.stringify(result).replace(/"/g, '&quot;')})">
                            <div class="card-body p-2">
                                <strong>${escapeHtml(result.title || result.name || 'Unknown')}</strong><br>
                                <small class="text-info">${escapeHtml(result.author || result.author_name || 'Unknown')}</small>${seriesText}
                                ${result.year ? `<br><small class="text-muted">${result.year}</small>` : ''}
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }

            resultsList.innerHTML = html;
            resultsDiv.style.display = 'block';
        })
        .catch(e => {
            statusDiv.classList.add('d-none');
            btn.disabled = false;
            showErrorWithHelp('Search error: ' + e, 'api');
        });
}

function searchBookDBForBook() {
    const query = document.getElementById('edit-search-query').value.trim();
    const author = document.getElementById('edit-book-author').value.trim();
    
    if (!query || query.length < 2) {
        showWarning('Please enter at least 2 characters to search.', 'Search Too Short');
        return;
    }

    const statusDiv = document.getElementById('edit-search-status');
    const statusText = document.getElementById('edit-search-status-text');
    const resultsDiv = document.getElementById('edit-search-results');
    const resultsList = document.getElementById('edit-search-results-list');
    const btn = document.getElementById('edit-search-bookbucket-btn');

    statusDiv.classList.remove('d-none');
    statusText.textContent = 'Searching BookBucket...';
    resultsDiv.style.display = 'none';
    resultsList.innerHTML = '';
    btn.disabled = true;

    let url = `/api/search_bookdb?q=${encodeURIComponent(query)}&limit=20`;
    if (author) {
        url += `&author=${encodeURIComponent(author)}`;
    }

    fetch(url)
        .then(r => r.json())
        .then(data => {
            statusDiv.classList.add('d-none');
            btn.disabled = false;

            if (data.error || !data.results || data.results.length === 0) {
                resultsList.innerHTML = '<div class="alert alert-info">No results found in BookBucket.</div>';
                resultsDiv.style.display = 'block';
                return;
            }

            let html = `<div class="mb-2"><small class="text-muted">Found ${data.results.length} result(s) from BookBucket</small></div>`;
            html += '<div class="mb-3"><h6 class="text-info">BookBucket</h6>';

            data.results.forEach(result => {
                const seriesText = result.series_name && result.series_position 
                    ? ` <small class="text-warning">(${result.series_name} #${result.series_position})</small>` 
                    : '';
                html += `
                    <div class="card bg-secondary bg-opacity-25 mb-2" style="cursor: pointer;" 
                         onclick="selectBookMetadata(${JSON.stringify(result).replace(/"/g, '&quot;')})">
                        <div class="card-body p-2">
                            <strong>${escapeHtml(result.name || result.title || 'Unknown')}</strong><br>
                            <small class="text-info">${escapeHtml(result.author_name || 'Unknown')}</small>${seriesText}
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            resultsList.innerHTML = html;
            resultsDiv.style.display = 'block';
        })
        .catch(e => {
            statusDiv.classList.add('d-none');
            btn.disabled = false;
            showErrorWithHelp('Search error: ' + e, 'api');
        });
}

function searchAudnexusASINForBook() {
    const asin = document.getElementById('edit-audnexus-asin').value.trim().toUpperCase();
    const region = document.getElementById('edit-audnexus-region').value;
    const btn = document.getElementById('edit-search-audnexus-btn');
    const resultDiv = document.getElementById('edit-audnexus-result');
    const resultContent = document.getElementById('edit-audnexus-result-content');

    if (!asin || asin.length !== 10) {
        showWarning('ASIN must be exactly 10 characters.', 'Invalid ASIN');
        return;
    }

    btn.disabled = true;
    resultContent.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm text-primary"></div> Searching...</div>';
    resultDiv.style.display = 'block';

    // Add timeout to prevent hanging (30 seconds max)
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 30000);

    fetch(`/api/search_audnexus_asin?asin=${asin}&region=${region}`, { signal: controller.signal })
        .then(r => {
            clearTimeout(timeoutId);
            return r.json();
        })
        .then(data => {
            clearTimeout(timeoutId);
            btn.disabled = false;
            if (data.success && data.result) {
                const result = data.result;
                const sourceName = result.source === 'audimeta' ? 'AudiMeta' : 'Audnexus';
                const series = result.series ? ` (${result.series}${result.series_position ? ' #' + result.series_position : ''})` : '';
                const year = result.year ? ` <span class="text-muted">(${result.year})</span>` : '';
                const narrator = result.narrator ? ` <small class="text-info">Narrated by ${result.narrator}</small>` : '';
                
                resultContent.innerHTML = `
                    <div class="list-group">
                        <a href="#" class="list-group-item list-group-item-action bg-dark text-light"
                           onclick="selectAudnexusResultForBook(); return false;">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <div class="fw-bold">${escapeHtml(result.title || 'Unknown')}</div>
                                    <div class="text-info">${escapeHtml(result.author || 'Unknown')}${year}</div>
                                    ${series ? `<div class="text-warning small">${escapeHtml(series)}</div>` : ''}
                                    ${narrator}
                                    <div class="text-muted small mt-1">ASIN: ${escapeHtml(result.asin || asin)} | Region: ${data.region.toUpperCase()}</div>
                                </div>
                                <span class="badge bg-primary ms-2">${sourceName}</span>
                            </div>
                        </a>
                    </div>
                `;
                
                // Store result for selection
                window._audnexusResultForBook = result;
            } else {
                resultContent.innerHTML = `<div class="alert alert-warning">${escapeHtml(data.error || 'No result found')}</div>`;
            }
        })
        .catch(e => {
            clearTimeout(timeoutId);
            btn.disabled = false;
            let errorMsg = 'Unknown error';
            if (e.name === 'AbortError') {
                errorMsg = 'Request timed out after 30 seconds. The ASIN may not be available or the service may be slow.';
            } else {
                errorMsg = e.message || e.toString();
            }
            resultContent.innerHTML = `<div class="alert alert-danger">Error: ${escapeHtml(errorMsg)}</div>`;
        });
}

function selectBookMetadata(result) {
    selectedBookMetadata = result;
    
    // Apply field selection if checkboxes are checked
    if (document.getElementById('edit-field-author')?.checked && (result.author || result.author_name)) {
        document.getElementById('edit-book-author').value = result.author || result.author_name;
    }
    if (document.getElementById('edit-field-title')?.checked && (result.title || result.name)) {
        document.getElementById('edit-book-title').value = result.title || result.name;
    }
    if (document.getElementById('edit-field-series')?.checked && (result.series || result.series_name)) {
        document.getElementById('edit-book-series').value = result.series || result.series_name;
    }
    if (document.getElementById('edit-field-series-position')?.checked && (result.series_position || result.series_num)) {
        document.getElementById('edit-book-series-position').value = result.series_position || result.series_num;
    }
    if (document.getElementById('edit-field-narrator')?.checked && result.narrator) {
        document.getElementById('edit-book-narrator').value = result.narrator;
    }
    
    // Show selected match
    const selectedDiv = document.getElementById('edit-selected-match');
    const selectedText = document.getElementById('edit-selected-match-text');
    const series = (result.series || result.series_name) ? ` (${result.series || result.series_name}${(result.series_position || result.series_num) ? ' #' + (result.series_position || result.series_num) : ''})` : '';
    selectedText.textContent = `${result.author || result.author_name || 'Unknown'} - ${result.title || result.name || 'Unknown'}${series}`;
    selectedDiv.classList.remove('d-none');
    
    // Show field selection panel
    document.getElementById('edit-field-selection').classList.remove('d-none');
    
    // Switch to manual tab
    const manualTab = document.getElementById('book-manual-tab');
    if (manualTab) {
        manualTab.click();
    }

    // Scroll to selected match
    selectedDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function selectAudnexusResultForBook() {
    if (!window._audnexusResultForBook) {
        return;
    }
    
    const book = window._audnexusResultForBook;
    const sourceName = book.source === 'audimeta' ? 'AudiMeta' : 'Audnexus';
    
    // Apply field selection if checkboxes are checked
    if (document.getElementById('edit-field-author')?.checked && book.author) {
        document.getElementById('edit-book-author').value = book.author;
    }
    if (document.getElementById('edit-field-title')?.checked && book.title) {
        document.getElementById('edit-book-title').value = book.title;
    }
    if (document.getElementById('edit-field-series')?.checked && book.series) {
        document.getElementById('edit-book-series').value = book.series;
    }
    if (document.getElementById('edit-field-series-position')?.checked && book.series_position) {
        document.getElementById('edit-book-series-position').value = book.series_position;
    }
    if (document.getElementById('edit-field-narrator')?.checked && book.narrator) {
        document.getElementById('edit-book-narrator').value = book.narrator;
    }
    
    // Store selected result
    selectedBookMetadata = {
        author_name: book.author,
        name: book.title,
        title: book.title,
        series_name: book.series,
        series_position: book.series_position,
        year_published: book.year,
        narrator: book.narrator,
        source: book.source || 'audnexus',
        asin: book.asin
    };
    
    // Show selected match
    const matchDiv = document.getElementById('edit-selected-match');
    const matchText = document.getElementById('edit-selected-match-text');
    const series = book.series ? ` (${book.series}${book.series_position ? ' #' + book.series_position : ''})` : '';
    matchText.textContent = `${book.author || 'Unknown'} - ${book.title || 'Unknown'}${series} [${sourceName}]`;
    matchDiv.classList.remove('d-none');
    
    // Show field selection panel
    document.getElementById('edit-field-selection').classList.remove('d-none');
    
    // Switch to manual tab
    const manualTab = document.getElementById('book-manual-tab');
    if (manualTab) {
        manualTab.click();
    }
    
    // Hide search results
    document.getElementById('edit-audnexus-result').style.display = 'none';
}

function clearBookSelection() {
    selectedBookMetadata = null;
    window._audnexusResultForBook = null;
    document.getElementById('edit-selected-match').classList.add('d-none');
    document.getElementById('edit-field-selection').classList.add('d-none');
}

function quickMatchForBook() {
    const query = document.getElementById('edit-quick-match-query').value.trim();
    const author = document.getElementById('edit-book-author').value.trim();
    const title = document.getElementById('edit-book-title').value.trim();
    
    // Use existing title/author if query is empty
    const searchQuery = query || (title ? `${author ? author + ' - ' : ''}${title}` : '');
    
    if (!searchQuery || searchQuery.length < 2) {
        showWarning('Please enter a search query or fill in author/title fields.', 'Search Required');
        return;
    }
    
    const btn = document.getElementById('edit-quick-match-btn');
    const resultDiv = document.getElementById('edit-quick-match-result');
    const resultContent = document.getElementById('edit-quick-match-result-content');
    const originalHtml = btn.innerHTML;
    
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Matching...';
    resultContent.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm text-primary me-2"></div>Searching all providers...</div>';
    resultDiv.style.display = 'block';
    
    // Search all APIs
    const searchUrl = `/api/search_all_apis?q=${encodeURIComponent(searchQuery)}${author ? '&author=' + encodeURIComponent(author) : ''}`;
    
    fetch(searchUrl)
        .then(r => r.json())
        .then(data => {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
            
            if (data.error || !data.results_by_source || Object.keys(data.results_by_source).length === 0) {
                resultContent.innerHTML = '<div class="alert alert-warning">No results found. Try manual search or ASIN lookup.</div>';
                return;
            }
            
            // Find best match (first result from most reliable source)
            const priority = ['BookBucket', 'Google Books', 'OpenLibrary', 'Hardcover'];
            let bestMatch = null;
            let bestSource = null;
            
            for (const source of priority) {
                if (data.results_by_source[source] && data.results_by_source[source].length > 0) {
                    bestMatch = data.results_by_source[source][0];
                    bestSource = source;
                    break;
                }
            }
            
            if (!bestMatch) {
                const firstSource = Object.keys(data.results_by_source)[0];
                bestMatch = data.results_by_source[firstSource][0];
                bestSource = firstSource;
            }
            
            if (bestMatch) {
                // Auto-select the best match
                selectedBookMetadata = {
                    author_name: bestMatch.author,
                    name: bestMatch.title,
                    title: bestMatch.title,
                    series_name: bestMatch.series,
                    series_position: bestMatch.series_position,
                    year_published: bestMatch.year,
                    source: bestSource
                };
                
                // Fill in fields
                if (bestMatch.author) {
                    document.getElementById('edit-book-author').value = bestMatch.author;
                }
                if (bestMatch.title) {
                    document.getElementById('edit-book-title').value = bestMatch.title;
                }
                if (bestMatch.series) {
                    document.getElementById('edit-book-series').value = bestMatch.series;
                }
                if (bestMatch.series_position) {
                    document.getElementById('edit-book-series-position').value = bestMatch.series_position;
                }
                
                // Show success
                const series = bestMatch.series ? ` (${bestMatch.series}${bestMatch.series_position ? ' #' + bestMatch.series_position : ''})` : '';
                resultContent.innerHTML = `
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle"></i> <strong>Quick Match Found!</strong><br>
                        ${escapeHtml(bestMatch.author || 'Unknown')} - ${escapeHtml(bestMatch.title || 'Unknown')}${series}<br>
                        <small class="text-muted">Source: ${bestSource} | Confidence: High</small>
                    </div>
                    <div class="mt-2">
                        <button class="btn btn-sm btn-primary" onclick="switchToBookManualTab()">
                            <i class="bi bi-pencil"></i> Review & Edit
                        </button>
                    </div>
                `;
                
                // Show selected match
                const matchDiv = document.getElementById('edit-selected-match');
                const matchText = document.getElementById('edit-selected-match-text');
                matchText.textContent = `${bestMatch.author || 'Unknown'} - ${bestMatch.title || 'Unknown'}${series} [${bestSource}]`;
                matchDiv.classList.remove('d-none');
                
                // Switch to manual tab
                setTimeout(() => {
                    const manualTab = document.getElementById('book-manual-tab');
                    if (manualTab) manualTab.click();
                }, 500);
            } else {
                resultContent.innerHTML = '<div class="alert alert-warning">No suitable match found. Try manual search.</div>';
            }
        })
        .catch(e => {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
            resultContent.innerHTML = `<div class="alert alert-danger">Error: ${escapeHtml(e.toString())}</div>`;
        });
}

function switchToBookManualTab() {
    const manualTab = document.getElementById('book-manual-tab');
    if (manualTab) {
        manualTab.click();
    }
}

function saveBookFix() {
    const bookId = document.getElementById('edit-book-id').value;
    const author = document.getElementById('edit-book-author').value.trim();
    const title = document.getElementById('edit-book-title').value.trim();

    if (!author || !title) {
        showWarning('Author and title are required to save a fix.', 'Required Fields');
        return;
    }

    const payload = {
        book_id: parseInt(bookId),
        author: author,
        title: title
    };

    // Include metadata result if one was selected
    if (selectedBookMetadata) {
        payload.metadata_result = selectedBookMetadata;
    }

    const btn = document.querySelector('#editBookModal .btn-primary');
    const originalHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';

    fetch('/api/manual_fix_book', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
    })
        .then(r => r.json())
        .then(data => {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
            
            if (data.success) {
                showSuccess('Saved as pending fix! Go to History > Pending to apply it.', 'Saved', null, null, {
                    url: '/history?status=pending',
                    text: 'View Pending Fixes'
                });
                if (editBookModal) {
                    editBookModal.hide();
                }
                setTimeout(() => location.reload(), 1500);
            } else {
                showErrorWithHelp(data.error || 'Unknown error', 'database');
            }
        })
        .catch(e => {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
            showErrorWithHelp('Error: ' + e, 'api');
        });
}
</script>
{% endblock %}
