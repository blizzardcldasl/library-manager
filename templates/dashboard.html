{% extends "base.html" %}
{% block title %}Dashboard - Library Manager{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-3">
        <a href="/books" class="text-decoration-none">
            <div class="card stat-card h-100" title="All audiobook folders found in your library" style="cursor: pointer;">
                <div class="card-body text-center">
                    <i class="bi bi-collection text-info" style="font-size: 2rem;"></i>
                    <div class="stat-number" id="total-books">{{ total_books }}</div>
                    <div class="text-muted">Total Books</div>
                    <small class="text-muted" style="font-size: 0.7rem;">in library</small>
                </div>
            </div>
        </a>
    </div>
    <div class="col-md-3">
        <a href="/queue" class="text-decoration-none">
            <div class="card stat-card h-100" title="Books waiting to be analyzed by AI" style="cursor: pointer;">
                <div class="card-body text-center">
                    <i class="bi bi-list-task text-warning" style="font-size: 2rem;"></i>
                    <div class="stat-number" id="queue-count">{{ queue_size }}</div>
                    <div class="text-muted">In Queue</div>
                    <small class="text-muted" style="font-size: 0.7rem;">awaiting AI analysis</small>
                </div>
            </div>
        </a>
    </div>
    <div class="col-md-3">
        <a href="/history" class="text-decoration-none">
            <div class="card stat-card h-100" title="Books that have been renamed/corrected" style="cursor: pointer;">
                <div class="card-body text-center">
                    <i class="bi bi-check-circle text-success" style="font-size: 2rem;"></i>
                    <div class="stat-number" id="fixed-count">{{ fixed_count }}</div>
                    <div class="text-muted">Fixed</div>
                    <small class="text-muted" style="font-size: 0.7rem;">renamed successfully</small>
                </div>
            </div>
        </a>
    </div>
    <div class="col-md-3">
        <a href="/history?status=pending" class="text-decoration-none">
            <div class="card stat-card h-100" title="AI suggested fixes waiting to be applied to files" style="cursor: pointer;">
                <div class="card-body text-center">
                    <i class="bi bi-hourglass-split text-danger" style="font-size: 2rem;"></i>
                    <div class="stat-number" id="pending-fixes">{{ pending_fixes }}</div>
                    <div class="text-muted">Pending Fixes</div>
                    <small class="text-muted" style="font-size: 0.7rem;">ready to apply</small>
                </div>
            </div>
        </a>
    </div>
</div>

<!-- Floating Quick Actions Button -->
<div class="position-fixed bottom-0 end-0 m-4" style="z-index: 1050;">
    <div class="dropup">
        <button class="btn btn-primary btn-lg rounded-circle shadow" type="button" data-bs-toggle="dropdown" aria-expanded="false" style="width: 60px; height: 60px;">
            <i class="bi bi-lightning-fill fs-4"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-end shadow mb-2" style="min-width: 200px;">
            <li><h6 class="dropdown-header">Quick Actions</h6></li>
            <li><a class="dropdown-item" href="#" onclick="triggerScan(); return false;" id="scan-btn">
                <i class="bi bi-search text-primary"></i> Scan Library
            </a></li>
            <li><a class="dropdown-item" href="#" onclick="deepRescan(); return false;" id="deep-scan-btn">
                <i class="bi bi-arrow-repeat text-info"></i> Deep Re-scan
            </a></li>
            <li><a class="dropdown-item" href="#" onclick="processQueue(); return false;" id="process-btn">
                <i class="bi bi-play-fill text-success"></i> Process Queue
            </a></li>
            {% if pending_fixes > 0 %}
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="#" onclick="applyAllPending(); return false;" id="apply-pending-btn">
                <i class="bi bi-check-all text-warning"></i> Apply {{ pending_fixes }} Pending
            </a></li>
            {% endif %}
            <li><hr class="dropdown-divider"></li>
            {% if worker_running %}
            <li><a class="dropdown-item" href="#" onclick="stopWorker(); return false;">
                <i class="bi bi-stop-fill text-danger"></i> Stop Worker
            </a></li>
            {% else %}
            <li><a class="dropdown-item" href="#" onclick="startWorker(); return false;">
                <i class="bi bi-play-fill text-success"></i> Start Worker
            </a></li>
            {% endif %}
        </ul>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-clock-history"></i> Recent Activity (Last 15)
            </div>
            <div class="card-body p-0" style="max-height: 400px; overflow-y: auto;">
                {% if recent_history %}
                <table class="table table-sm mb-0" id="recent-activity-table">
                    <thead style="position: sticky; top: 0; background: rgba(22, 33, 62, 0.95);">
                        <tr>
                            <th>Date</th>
                            <th>Original</th>
                            <th></th>
                            <th>Fixed To</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for h in recent_history[:15] %}
                        <tr>
                            <td><small>{{ h.fixed_at[5:16] }}</small></td>
                            <td class="text-truncate" style="max-width: 200px;">
                                <span class="text-danger">{{ h.old_author }}</span> /
                                <span class="text-warning">{{ h.old_title }}</span>
                            </td>
                            <td><i class="bi bi-arrow-right text-info"></i></td>
                            <td class="text-truncate" style="max-width: 200px;">
                                <span class="text-success">{{ h.new_author }}</span> /
                                <span class="text-info">{{ h.new_title }}</span>
                            </td>
                            <td>
                                {% if h.status == 'undone' %}
                                <span class="badge bg-info">Undone</span>
                                {% elif h.old_path != h.new_path %}
                                <span class="badge bg-danger">Fixed</span>
                                {% else %}
                                <span class="badge bg-warning text-dark">OK</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if h.status == 'fixed' and h.old_path != h.new_path %}
                                <button class="btn btn-sm btn-outline-warning py-0 px-1" onclick="undoFix({{ h.id }})" title="Undo">
                                    <i class="bi bi-arrow-counterclockwise"></i>
                                </button>
                                {% else %}
                                -
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
                    <h5 class="mt-3 text-muted">No Activity Yet</h5>
                    <p class="text-muted mb-3">Start by scanning your library to find books that need fixing.</p>
                    <div class="d-flex gap-2 justify-content-center">
                        <button class="btn btn-primary btn-sm" onclick="triggerScan()">
                            <i class="bi bi-search"></i> Scan Library
                        </button>
                        <a href="/queue" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-list-task"></i> View Queue
                        </a>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-gear"></i> Current Configuration
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <strong>Library Paths:</strong><br>
                        {% for path in config.library_paths %}
                        <code>{{ path }}</code><br>
                        {% endfor %}
                    </div>
                    <div class="col-md-4">
                        <strong>AI Model:</strong> {{ config.openrouter_model }}<br>
                        <strong>Scan Interval:</strong> Every {{ config.scan_interval_hours }} hours<br>
                        <strong>Batch Size:</strong> {{ config.batch_size }} books
                    </div>
                    <div class="col-md-4">
                        <strong>Auto-Fix:</strong>
                        {% if config.auto_fix %}
                        <span class="badge bg-success">Enabled</span>
                        {% else %}
                        <span class="badge bg-warning text-dark">Manual Approval</span>
                        {% endif %}
                        <br>
                        <strong>Status:</strong>
                        {% if config.enabled %}
                        <span class="badge bg-success">Enabled</span>
                        {% else %}
                        <span class="badge bg-danger">Disabled</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function triggerScan() {
    const btn = document.getElementById('scan-btn');
    const originalHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Scanning...';
    
    // Create progress indicator
    const progressContainer = document.createElement('div');
    progressContainer.id = 'scan-progress-container';
    progressContainer.className = 'mb-3';
    const cardBody = document.querySelector('.card-body');
    if (cardBody) {
        cardBody.insertBefore(progressContainer, cardBody.firstChild);
    }
    
    const progressBar = createProgressBar('scan-progress-container', 'Library Scan Progress');
    showInfo('Scanning library for books... This may take a few moments.', 'Scan Started');
    
    // Poll for progress
    let progressInterval = setInterval(() => {
        fetch('/api/stats')
            .then(r => r.json())
            .then(data => {
                if (data.scan_progress) {
                    progressBar.update(
                        data.scan_progress.processed || 0,
                        data.scan_progress.total || 0,
                        data.scan_progress.status || 'Scanning...'
                    );
                }
            })
            .catch(() => {}); // Ignore errors in progress polling
    }, 1000);

    fetch('/api/scan', {method: 'POST'})
        .then(r => r.json())
        .then(data => {
            clearInterval(progressInterval);
            progressBar.remove();
            btn.disabled = false;
            btn.innerHTML = originalHtml;
            if (data.scanned || data.queued) {
                showSuccess(
                    `Scan complete! Found ${data.scanned || 0} new books, ${data.queued || 0} added to queue.`,
                    'Scan Complete'
                );
            } else {
                showInfo('Scan complete. No new books found.', 'Scan Complete');
            }
            setTimeout(() => location.reload(), 1500);
        })
        .catch(e => {
            clearInterval(progressInterval);
            progressBar.remove();
            btn.disabled = false;
            btn.innerHTML = originalHtml;
            showErrorWithHelp('Scan failed: ' + e, 'scan');
        });
}

function deepRescan() {
    if (!confirm('Deep Re-scan will queue ALL books for fresh metadata verification using the new API chain. This may take a while. Continue?')) return;

    const btn = document.getElementById('deep-scan-btn');
    const originalHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Resetting...';
    
    showWarning('Deep re-scan started. This may take several minutes for large libraries.', 'Deep Re-scan Started');

    fetch('/api/deep_rescan', {method: 'POST'})
        .then(r => r.json())
        .then(data => {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
            showSuccess(data.message || 'Deep re-scan complete. All books queued for verification.', 'Deep Re-scan Complete');
            setTimeout(() => location.reload(), 2000);
        })
        .catch(e => {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
            showErrorWithHelp('Deep re-scan failed: ' + e, 'scan');
        });
}

function processQueue() {
    const btn = document.getElementById('process-btn');
    const originalHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Processing...';
    
    showInfo('Processing queue... This may take a few moments.', 'Processing');

    fetch('/api/process', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({limit: 3})
    })
        .then(r => r.json())
        .then(data => {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
            if (data.fixed > 0) {
                showSuccess(`Processed ${data.fixed} books. Check the queue for results.`, 'Processing Complete');
            } else {
                showInfo('Processing complete. No books were fixed in this batch.', 'Processing Complete');
            }
            setTimeout(() => location.reload(), 1500);
        })
        .catch(e => {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
            showErrorWithHelp('Processing failed: ' + e, 'api');
        });
}

function startWorker() {
    fetch('/api/worker/start', {method: 'POST'})
        .then(r => r.json())
        .then(() => location.reload());
}

function stopWorker() {
    fetch('/api/worker/stop', {method: 'POST'})
        .then(r => r.json())
        .then(() => location.reload());
}

function applyAllPending() {
    if (!confirm('Apply all pending fixes? This will rename folders in your library.')) return;

    const btn = document.getElementById('apply-pending-btn');
    const originalHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Applying...';
    
    showWarning('Applying all pending fixes. This will rename folders in your library.', 'Applying Fixes');

    fetch('/api/apply_all_pending', {method: 'POST'})
        .then(r => r.json())
        .then(data => {
            showSuccess(data.message || 'All pending fixes applied successfully.', 'Fixes Applied');
            setTimeout(() => location.reload(), 2000);
        })
        .catch(e => {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
            showErrorWithHelp('Failed to apply fixes: ' + e, 'file');
        });
}

function undoFix(historyId) {
    if (!confirm('Undo this fix? The folder will be renamed back to its original name.')) return;

    fetch(`/api/undo/${historyId}`, {method: 'POST'})
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                showSuccess(data.message || 'Fix undone successfully.', 'Undone');
                setTimeout(() => location.reload(), 1500);
            } else {
                showErrorWithHelp(data.error || 'Unknown error', 'file');
            }
        })
        .catch(e => showErrorWithHelp('Error: ' + e, 'api'));
}

// Auto-refresh stats and recent activity
function refreshDashboard() {
    fetch('/api/stats')
        .then(r => r.json())
        .then(data => {
            document.getElementById('total-books').textContent = data.total_books;
            document.getElementById('queue-count').textContent = data.queue_size;
            document.getElementById('fixed-count').textContent = data.fixed;
            document.getElementById('pending-fixes').textContent = data.pending_fixes || 0;
        })
        .catch(e => console.error('Stats refresh error:', e));

    fetch('/api/recent_history')
        .then(r => r.json())
        .then(data => {
            const tbody = document.querySelector('#recent-activity-table tbody');
            if (tbody && data.items) {
                tbody.innerHTML = data.items.map(h => `
                    <tr>
                        <td><small>${h.fixed_at ? h.fixed_at.substring(5, 16) : ''}</small></td>
                        <td class="text-truncate" style="max-width: 200px;">
                            <span class="text-danger">${escapeHtml(h.old_author)}</span> /
                            <span class="text-warning">${escapeHtml(h.old_title)}</span>
                        </td>
                        <td><i class="bi bi-arrow-right text-info"></i></td>
                        <td class="text-truncate" style="max-width: 200px;">
                            <span class="text-success">${escapeHtml(h.new_author)}</span> /
                            <span class="text-info">${escapeHtml(h.new_title)}</span>
                        </td>
                        <td>
                            ${h.status === 'undone' ?
                                '<span class="badge bg-info">Undone</span>' :
                                h.old_path !== h.new_path ?
                                    '<span class="badge bg-danger">Fixed</span>' :
                                    '<span class="badge bg-warning text-dark">OK</span>'}
                        </td>
                        <td>
                            ${h.status === 'fixed' && h.old_path !== h.new_path ?
                                `<button class="btn btn-sm btn-outline-warning py-0 px-1" onclick="undoFix(${h.id})" title="Undo"><i class="bi bi-arrow-counterclockwise"></i></button>` :
                                '-'}
                        </td>
                    </tr>
                `).join('');
            }
        })
        .catch(e => console.error('History refresh error:', e));
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Start auto-refresh immediately and every 5 seconds
refreshDashboard();
setInterval(refreshDashboard, 5000);
console.log('Dashboard auto-refresh active (every 5s)');
</script>
{% endblock %}
