{% extends "base.html" %}
{% block title %}Queue - Library Manager{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-list-task"></i> Processing Queue <span class="badge bg-warning" id="queue-badge">{{ queue_items|length }}</span></h2>
    <div>
        <button class="btn btn-success" onclick="processAll()" id="process-all-btn">
            <i class="bi bi-play-fill"></i> Process All
        </button>
        <button class="btn btn-primary" onclick="processOne()" id="process-one-btn">
            <i class="bi bi-skip-forward"></i> Process 1 Batch
        </button>
        <button class="btn btn-outline-secondary" onclick="refreshQueue()">
            <i class="bi bi-arrow-clockwise"></i> Refresh
        </button>
    </div>
</div>

<!-- Real-time Search -->
<div class="card mb-3">
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <label class="form-label">Live Search</label>
                <input type="text" class="form-control bg-dark text-light" id="queue-live-search" 
                       placeholder="Type to filter queue items..." onkeyup="liveFilterQueue(this.value)">
                <small class="text-muted"><span id="queue-filter-count">{{ queue_items|length }}</span> shown</small>
            </div>
        </div>
    </div>
</div>

<!-- Processing Status Banner -->
<div id="processing-banner" class="alert alert-info d-none mb-4">
    <div class="d-flex align-items-center">
        <div class="spinner-border spinner-border-sm me-3" role="status"></div>
        <div>
            <strong>Processing...</strong>
            <span id="processing-status">Starting...</span>
        </div>
    </div>
    <div class="progress mt-2" style="height: 20px;">
        <div class="progress-bar progress-bar-striped progress-bar-animated" id="processing-progress" style="width: 0%">0%</div>
    </div>
</div>

<!-- Debug Log Panel -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between">
        <span><i class="bi bi-terminal"></i> Live Log</span>
        <div>
            <button class="btn btn-sm btn-outline-secondary me-2" onclick="toggleAutoScroll()" id="autoscroll-btn" title="Toggle auto-scroll to bottom">
                <i class="bi bi-arrow-down-circle"></i> Auto-scroll
            </button>
            <button class="btn btn-sm btn-outline-secondary" onclick="clearLog()" title="Clear log">
                <i class="bi bi-x-circle"></i> Clear
            </button>
        </div>
    </div>
    <div class="card-body bg-dark p-2" id="log-container" style="height: 200px; overflow-y: auto; overflow-x: hidden; scroll-behavior: smooth;">
        <pre id="debug-log" class="text-success mb-0" style="font-size: 0.85rem; white-space: pre-wrap; word-wrap: break-word; margin: 0;"></pre>
    </div>
</div>

<div id="queue-container">
{% if queue_items %}
<div class="card">
    <div class="card-body p-0" style="max-height: 500px; overflow-y: auto;">
        <table class="table table-sm mb-0" id="queue-table">
            <thead style="position: sticky; top: 0; background: rgba(22, 33, 62, 0.95); z-index: 10;">
                <tr>
                    <th>Author</th>
                    <th>Title</th>
                    <th>Issue</th>
                    <th>Added</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="queue-body">
                {% for item in queue_items %}
                <tr id="queue-{{ item.id }}" data-book-id="{{ item.book_id }}">
                    <td class="text-truncate" style="max-width: 150px;">
                        <span class="text-warning">{{ item.current_author }}</span>
                    </td>
                    <td class="text-truncate" style="max-width: 200px;">{{ item.current_title }}</td>
                    <td>
                        <small class="badge bg-danger text-wrap issue-badge" style="max-width: 200px;" 
                               data-bs-toggle="tooltip" 
                               data-bs-html="true"
                               data-issue-reason="{{ item.reason or 'Unknown' }}"
                               title="">
                            <span class="issue-text">{{ item.reason or 'Unknown' }}</span>
                        </small>
                    </td>
                    <td><small>{{ item.added_at[5:16] if item.added_at else '?' }}</small></td>
                    <td>
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-sm btn-outline-primary" onclick="editItem({{ item.id }}, '{{ item.current_author | e }}', '{{ item.current_title | e }}', '{{ item.path | e }}')" title="Edit" data-bs-toggle="tooltip">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-info" onmouseenter="showQuickPreview({{ item.book_id }})" onmouseleave="hideQuickPreview()" title="Quick Preview" data-bs-toggle="tooltip">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="removeFromQueue({{ item.id }})" title="Mark as OK" data-bs-toggle="tooltip">
                                <i class="bi bi-check"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="mt-3">
    <small class="text-muted">
        <span id="queue-count">{{ queue_items|length }}</span> items in queue.
        Books flagged due to: years in author names, title words in author, author/title swaps, etc.
    </small>
</div>
{% else %}
<div class="card" id="empty-queue">
    <div class="card-body text-center py-5">
        <i class="bi bi-check-circle text-success" style="font-size: 4rem;"></i>
        <h4 class="mt-3">Queue is empty!</h4>
        <p class="text-muted">All books have been processed. Run a scan to check for new issues.</p>
        <a href="/" class="btn btn-primary">Back to Dashboard</a>
    </div>
</div>
{% endif %}
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-pencil"></i> Edit Book Metadata</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-queue-id">

                <!-- Current Path Display -->
                <div class="alert alert-info mb-3">
                    <div class="d-flex align-items-start">
                        <i class="bi bi-folder me-2 mt-1"></i>
                        <div class="flex-grow-1">
                            <strong>Current Path:</strong><br>
                            <code class="text-warning small fw-bold" id="edit-current-path" style="word-break: break-all;">Loading...</code>
                        </div>
                    </div>
                </div>

                <!-- Tabbed Interface -->
                <ul class="nav nav-tabs mb-3" id="metadataTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="manual-tab" data-bs-toggle="tab" data-bs-target="#manual-pane" type="button" role="tab">
                            <i class="bi bi-pencil-square"></i> Manual Entry
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="asin-tab" data-bs-toggle="tab" data-bs-target="#asin-pane" type="button" role="tab">
                            <i class="bi bi-upc"></i> ASIN Lookup
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="search-tab" data-bs-toggle="tab" data-bs-target="#search-pane" type="button" role="tab">
                            <i class="bi bi-search"></i> Search APIs
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="quick-match-tab" data-bs-toggle="tab" data-bs-target="#quick-match-pane" type="button" role="tab">
                            <i class="bi bi-lightning"></i> Quick Match
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="metadataTabContent">
                    <!-- Manual Entry Tab -->
                    <div class="tab-pane fade show active" id="manual-pane" role="tabpanel">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label"><i class="bi bi-person"></i> Author</label>
                                <input type="text" class="form-control bg-dark text-light" id="edit-author" placeholder="Author Name">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label"><i class="bi bi-book"></i> Title</label>
                                <input type="text" class="form-control bg-dark text-light" id="edit-title" placeholder="Book Title">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label"><i class="bi bi-collection"></i> Series</label>
                                <input type="text" class="form-control bg-dark text-light" id="edit-series" placeholder="Series Name (optional)">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label"><i class="bi bi-hash"></i> Series Position</label>
                                <input type="text" class="form-control bg-dark text-light" id="edit-series-position" placeholder="1, 2, 3... (optional)">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label"><i class="bi bi-mic"></i> Narrator</label>
                                <input type="text" class="form-control bg-dark text-light" id="edit-narrator" placeholder="Narrator (optional)">
                            </div>
                        </div>
                        <div class="alert alert-secondary">
                            <small><i class="bi bi-info-circle"></i> Enter metadata manually or use other tabs to search for it.</small>
                        </div>
                    </div>

                    <!-- ASIN Lookup Tab -->
                    <div class="tab-pane fade" id="asin-pane" role="tabpanel">
                        <div class="mb-3">
                            <label class="form-label"><i class="bi bi-upc"></i> Audible ASIN Lookup</label>
                            <div class="input-group mb-2">
                                <input type="text" class="form-control bg-dark text-light" id="audnexus-asin" placeholder="Enter ASIN (e.g., B002V5H8FK)" maxlength="10" style="text-transform: uppercase;">
                                <select class="form-select bg-dark text-light" id="audnexus-region" style="max-width: 120px;">
                                    <option value="us">ðŸ‡ºðŸ‡¸ US</option>
                                    <option value="uk">ðŸ‡¬ðŸ‡§ UK</option>
                                    <option value="au">ðŸ‡¦ðŸ‡º AU</option>
                                    <option value="ca">ðŸ‡¨ðŸ‡¦ CA</option>
                                    <option value="de">ðŸ‡©ðŸ‡ª DE</option>
                                    <option value="es">ðŸ‡ªðŸ‡¸ ES</option>
                                    <option value="fr">ðŸ‡«ðŸ‡· FR</option>
                                    <option value="in">ðŸ‡®ðŸ‡³ IN</option>
                                    <option value="it">ðŸ‡®ðŸ‡¹ IT</option>
                                    <option value="jp">ðŸ‡¯ðŸ‡µ JP</option>
                                </select>
                                <button class="btn btn-primary" type="button" onclick="searchAudnexusASIN()" id="search-audnexus-btn">
                                    <i class="bi bi-search"></i> Lookup
                                </button>
                            </div>
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i> Searches AudiMeta (faster) and Audnexus. Enter 10-character Audible ASIN.
                            </small>
                        </div>

                        <!-- ASIN Result -->
                        <div id="audnexus-result" class="mb-3" style="display: none;">
                            <div id="audnexus-result-content"></div>
                        </div>
                    </div>

                    <!-- Search APIs Tab -->
                    <div class="tab-pane fade" id="search-pane" role="tabpanel">
                        <div class="mb-3">
                            <label class="form-label"><i class="bi bi-search"></i> Search All Metadata Sources</label>
                            <div class="input-group mb-2">
                                <input type="text" class="form-control bg-dark text-light" id="search-query" placeholder="Search by title or author...">
                                <button class="btn btn-primary" type="button" onclick="searchAllAPIs()" id="search-all-apis-btn">
                                    <i class="bi bi-search"></i> Search All
                                </button>
                                <button class="btn btn-outline-info" type="button" onclick="searchBookDB()" id="search-bookbucket-btn" title="Search only BookBucket">
                                    <i class="bi bi-database"></i> BookBucket
                                </button>
                            </div>
                    <small class="text-muted">
                        <i class="bi bi-info-circle"></i> Searches: AudiMeta, OpenLibrary, Google Books, Hardcover, and BookBucket
                    </small>
                        </div>

                        <!-- Search Status -->
                        <div id="search-status" class="mb-2 d-none">
                            <div class="d-flex align-items-center">
                                <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                                <small class="text-muted" id="search-status-text">Searching APIs...</small>
                            </div>
                        </div>

                        <!-- Search Results -->
                        <div id="search-results" class="mb-3" style="max-height: 450px; overflow-y: auto; display: none;">
                            <div id="search-results-list">
                                <!-- Results inserted here - grouped by source -->
                            </div>
                        </div>
                    </div>

                    <!-- Quick Match Tab -->
                    <div class="tab-pane fade" id="quick-match-pane" role="tabpanel">
                        <div class="alert alert-warning mb-3">
                            <i class="bi bi-lightning-fill"></i> <strong>Quick Match</strong> automatically finds and selects the best match from all metadata sources.
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Search Query</label>
                            <div class="input-group">
                                <input type="text" class="form-control bg-dark text-light" id="quick-match-query" placeholder="Enter book title or author...">
                                <button class="btn btn-primary" type="button" onclick="quickMatch()" id="quick-match-btn">
                                    <i class="bi bi-lightning"></i> Quick Match
                                </button>
                            </div>
                            <small class="text-muted">Searches all providers and auto-selects the best match if confidence is high enough.</small>
                        </div>
                        <div id="quick-match-result" style="display: none;">
                            <div id="quick-match-result-content"></div>
                        </div>
                    </div>
                </div>

                <!-- Selected Match Display -->
                <div id="selected-match" class="alert alert-success d-none mt-3">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <strong><i class="bi bi-check-circle"></i> Selected Match:</strong><br>
                            <span id="selected-match-text"></span>
                        </div>
                        <button type="button" class="btn-close" onclick="clearSelection()" aria-label="Clear selection"></button>
                    </div>
                </div>

                <!-- Field Selection (when match selected) -->
                <div id="field-selection" class="card bg-secondary bg-opacity-25 mt-3 d-none">
                    <div class="card-header">
                        <small><i class="bi bi-check2-square"></i> Select fields to import:</small>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="field-author" checked>
                                    <label class="form-check-label" for="field-author">Author</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="field-title" checked>
                                    <label class="form-check-label" for="field-title">Title</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="field-series">
                                    <label class="form-check-label" for="field-series">Series Name</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="field-series-position">
                                    <label class="form-check-label" for="field-series-position">Series Position</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="field-narrator">
                                    <label class="form-check-label" for="field-narrator">Narrator</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="field-year">
                                    <label class="form-check-label" for="field-year">Year</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="field-description">
                                    <label class="form-check-label" for="field-description">Description</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="field-cover">
                                    <label class="form-check-label" for="field-cover">Cover Art</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Path Preview -->
                <div id="path-preview" class="alert alert-info d-none mt-3">
                    <strong><i class="bi bi-eye"></i> Preview:</strong><br>
                    <div class="row mt-2">
                        <div class="col-md-6">
                            <small class="text-muted">Current:</small><br>
                            <code class="text-danger small" id="preview-old-path" style="word-break: break-all;"></code>
                        </div>
                        <div class="col-md-6">
                            <small class="text-muted">New:</small><br>
                            <code class="text-success small" id="preview-new-path" style="word-break: break-all;"></code>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-outline-primary" onclick="saveAsPending()">
                    <i class="bi bi-save"></i> Save as Pending
                </button>
                <button type="button" class="btn btn-primary" onclick="applyDirectly()" id="apply-directly-btn">
                    <i class="bi bi-check-lg"></i> Apply Now
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Book Hover Card -->
<div id="book-hover-card" class="book-hover-card">
    <div class="card-header">
        <div class="d-flex align-items-start gap-3">
            <div id="hover-cover-container">
                <div class="book-cover-placeholder"><i class="bi bi-book"></i></div>
            </div>
            <div class="flex-grow-1">
                <div class="book-title" id="hover-title">Loading...</div>
                <div class="book-author" id="hover-author"></div>
                <div class="book-series" id="hover-series"></div>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="book-meta mb-2" id="hover-meta"></div>
        <div class="book-description" id="hover-description"></div>
        <div class="book-tags mt-2" id="hover-tags"></div>
        <div class="abs-status" id="hover-abs-status" style="display: none;">
            <small class="text-muted"><i class="bi bi-headphones"></i> AudiobookShelf Status</small>
            <div id="hover-abs-users"></div>
        </div>
    </div>
    <div class="click-hint">
        <i class="bi bi-mouse"></i> Click to select this book
    </div>
</div>

<!-- Book Detail Modal -->
<div class="modal fade" id="bookDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark">
            <div class="modal-header" style="border-color: #0f3460;">
                <h5 class="modal-title"><i class="bi bi-book"></i> Book Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-3 text-center">
                        <div id="detail-cover-container" class="mb-3">
                            <div class="book-cover-placeholder" style="width: 150px; height: 220px; margin: auto;">
                                <i class="bi bi-book" style="font-size: 3rem;"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-9">
                        <h4 id="detail-title" class="mb-1">Book Title</h4>
                        <p id="detail-author" class="text-info mb-2"></p>
                        <p id="detail-series" class="text-warning mb-2" style="display: none;"></p>
                        <div class="row mb-3">
                            <div class="col-auto" id="detail-year-container" style="display: none;">
                                <small class="text-muted">Year: </small><span id="detail-year"></span>
                            </div>
                            <div class="col-auto" id="detail-pages-container" style="display: none;">
                                <small class="text-muted">Pages: </small><span id="detail-pages"></span>
                            </div>
                            <div class="col-auto" id="detail-language-container" style="display: none;">
                                <small class="text-muted">Language: </small><span id="detail-language"></span>
                            </div>
                        </div>
                        <div id="detail-isbns" class="mb-3" style="display: none;">
                            <small class="text-muted">ISBN: </small><code id="detail-isbn"></code>
                        </div>
                        <div id="detail-subjects" class="mb-3"></div>
                    </div>
                </div>
                <hr style="border-color: #0f3460;">
                <div id="detail-description" class="mb-3" style="max-height: 200px; overflow-y: auto;"></div>
                <div id="detail-abs-section" class="alert alert-info" style="display: none;">
                    <h6><i class="bi bi-headphones"></i> AudiobookShelf Status</h6>
                    <div id="detail-abs-users"></div>
                </div>
            </div>
            <div class="modal-footer" style="border-color: #0f3460;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="useBookFromDetail()">
                    <i class="bi bi-check-lg"></i> Use This Book
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let isProcessing = false;
let pollInterval = null;
let autoScrollEnabled = true;

// Format issue strings for better readability
function formatIssue(issueStr) {
    if (!issueStr) return 'Unknown';
    
    // Handle file_folder_mismatch with detailed info
    if (issueStr.includes('file_folder_mismatch:')) {
        const parts = issueStr.split('|');
        let formatted = parts[0].replace('file_folder_mismatch:', '');
        
        if (parts.length > 1) {
            const details = parts.slice(1).join('|');
            const detailParts = details.split('|');
            
            let detailHtml = '<div class="mt-1" style="font-size: 0.85em;">';
            let hasAuthorMismatch = false;
            let hasTitleMismatch = false;
            
            for (const part of detailParts) {
                if (part.startsWith('author_mismatch')) {
                    hasAuthorMismatch = true;
                    const match = part.match(/author_mismatch\((\d+)\/(\d+)\)/);
                    if (match) {
                        detailHtml += `<div class="text-warning"><i class="bi bi-exclamation-triangle"></i> Author mismatch: ${match[1]}/${match[2]} files</div>`;
                    }
                } else if (part.startsWith('title_mismatch')) {
                    hasTitleMismatch = true;
                    const match = part.match(/title_mismatch\((\d+)\/(\d+)\)/);
                    if (match) {
                        detailHtml += `<div class="text-warning"><i class="bi bi-exclamation-triangle"></i> Title mismatch: ${match[1]}/${match[2]} files</div>`;
                    }
                } else if (part.startsWith('file_authors=')) {
                    const authors = part.replace('file_authors=', '').replace(/\+(\d+)_more/, '');
                    detailHtml += `<div class="text-muted small ms-3">Files show: ${escapeHtml(authors)}</div>`;
                } else if (part.startsWith('file_titles=')) {
                    const titles = part.replace('file_titles=', '').replace(/\+(\d+)_more/, '');
                    detailHtml += `<div class="text-muted small ms-3">Files show: ${escapeHtml(titles)}</div>`;
                } else if (part.startsWith('no_metadata')) {
                    const match = part.match(/no_metadata\((\d+)\)/);
                    if (match) {
                        detailHtml += `<div class="text-info small"><i class="bi bi-info-circle"></i> ${match[1]} file(s) have no metadata</div>`;
                    }
                }
            }
            
            detailHtml += '</div>';
            
            // Add summary
            if (hasAuthorMismatch && hasTitleMismatch) {
                formatted = 'Files don\'t match folder (author & title)' + detailHtml;
            } else if (hasAuthorMismatch) {
                formatted = 'Files in wrong author folder' + detailHtml;
            } else if (hasTitleMismatch) {
                formatted = 'Files don\'t match folder title' + detailHtml;
            } else {
                formatted += detailHtml;
            }
            
            return formatted;
        }
        
        return formatted;
    }
    
    // Handle other issue types
    return issueStr.replace(/_/g, ' ').replace(/:/g, ': ');
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Get issue tooltip text (server-side helper would be better, but using JS for now)
function getIssueTooltip(issueStr) {
    if (!issueStr) return 'Unknown issue';
    
    const tooltips = {
        'author_mismatch': 'Files show different author than folder. Usually means book is in wrong author folder or files have incorrect metadata.',
        'title_mismatch': 'Files show different title than folder. Check if title is correct or if files belong to a different book.',
        'file_folder_mismatch': 'Files don\'t match the folder structure. Could be naming issue or book in wrong location.',
        'year_in_author': 'Year found in author name. Should be removed or moved to title.',
        'author_in_title': 'Author name found in title. Should be removed.',
        'missing_firstname': 'Author appears to be missing first name (e.g., "Boyett" instead of "Steven Boyett").',
        'structure_reversed': 'Author and title appear to be swapped in folder structure.',
        'loose_file': 'Audio file found in library root without proper folder structure.',
        'empty_folder': 'Folder exists but contains no audio files.',
        'duplicate_file': 'Multiple files with same content found in different locations.'
    };
    
    // Check for partial matches
    for (const [key, tooltip] of Object.entries(tooltips)) {
        if (issueStr.toLowerCase().includes(key.toLowerCase())) {
            return tooltip;
        }
    }
    
    return issueStr.replace(/_/g, ' ').replace(/:/g, ': ');
}

// Format issues on page load
document.addEventListener('DOMContentLoaded', function() {
    const issueElements = document.querySelectorAll('.issue-text');
    issueElements.forEach(el => {
        const originalText = el.textContent;
        const formatted = formatIssue(originalText);
        if (formatted !== originalText) {
            el.innerHTML = formatted;
        }
    });
    
    // Initialize tooltips for issue badges
    const issueBadges = document.querySelectorAll('.issue-badge, [data-bs-toggle="tooltip"]');
    issueBadges.forEach(badge => {
        // Get issue reason from data attribute or text content
        const issueReason = badge.getAttribute('data-issue-reason') || 
                           badge.querySelector('.issue-text')?.textContent || 
                           badge.textContent || '';
        
        if (issueReason && issueReason !== 'Unknown') {
            const tooltipText = getIssueTooltip(issueReason);
            badge.setAttribute('title', tooltipText);
            badge.setAttribute('data-bs-html', 'true');
        }
        
        // Initialize Bootstrap tooltip
        if (badge.getAttribute('data-bs-toggle') === 'tooltip') {
            new bootstrap.Tooltip(badge);
        }
    });
});

function log(msg) {
    const logEl = document.getElementById('debug-log');
    const logContainer = document.getElementById('log-container');
    const time = new Date().toLocaleTimeString();
    logEl.innerHTML += `[${time}] ${msg}\n`;
    
    // Scroll the container, not the pre element
    if (autoScrollEnabled) {
        // Use setTimeout to ensure DOM is updated before scrolling
        setTimeout(() => {
            logContainer.scrollTop = logContainer.scrollHeight;
        }, 0);
    }
}

function clearLog() {
    document.getElementById('debug-log').innerHTML = '';
    // Reset scroll position
    const logContainer = document.getElementById('log-container');
    logContainer.scrollTop = 0;
}

function toggleAutoScroll() {
    autoScrollEnabled = !autoScrollEnabled;
    const btn = document.getElementById('autoscroll-btn');
    const logContainer = document.getElementById('log-container');
    
    if (autoScrollEnabled) {
        btn.innerHTML = '<i class="bi bi-arrow-down-circle"></i> Auto-scroll';
        btn.classList.remove('btn-warning');
        btn.classList.add('btn-outline-secondary');
        // Scroll to bottom when re-enabling
        setTimeout(() => {
            logContainer.scrollTop = logContainer.scrollHeight;
        }, 0);
    } else {
        btn.innerHTML = '<i class="bi bi-pause-circle"></i> Paused';
        btn.classList.remove('btn-outline-secondary');
        btn.classList.add('btn-warning');
    }
}

function showProcessingBanner(show) {
    const banner = document.getElementById('processing-banner');
    if (show) {
        banner.classList.remove('d-none');
    } else {
        banner.classList.add('d-none');
    }
}

function updateProgress(processed, total) {
    const pct = total > 0 ? Math.round((processed / total) * 100) : 0;
    document.getElementById('processing-progress').style.width = pct + '%';
    document.getElementById('processing-progress').textContent = `${processed}/${total} (${pct}%)`;
    document.getElementById('processing-status').textContent = `Processed ${processed} of ${total} items`;
}

function processAll() {
    if (isProcessing) {
        log('Already processing...');
        return;
    }

    if (!confirm('Process ALL items in queue? This will make multiple API calls.')) return;

    isProcessing = true;
    showProcessingBanner(true);
    log('Starting Process All...');

    document.getElementById('process-all-btn').disabled = true;
    document.getElementById('process-one-btn').disabled = true;

    // Start polling for status
    pollInterval = setInterval(pollStatus, 2000);

    fetch('/api/process', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({all: true})
    })
    .then(r => r.json())
    .then(data => {
        log(`Process All complete: ${data.processed} processed, ${data.fixed} fixed`);
        isProcessing = false;
        showProcessingBanner(false);
        clearInterval(pollInterval);
        document.getElementById('process-all-btn').disabled = false;
        document.getElementById('process-one-btn').disabled = false;
        refreshQueue();
    })
    .catch(e => {
        log('ERROR: ' + e);
        isProcessing = false;
        showProcessingBanner(false);
        clearInterval(pollInterval);
        document.getElementById('process-all-btn').disabled = false;
        document.getElementById('process-one-btn').disabled = false;
    });
}

function processOne() {
    log('Processing one batch...');

    fetch('/api/process', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({limit: 3})
    })
    .then(r => r.json())
    .then(data => {
        log(`Batch complete: ${data.processed} processed, ${data.fixed} fixed`);
        refreshQueue();
    })
    .catch(e => log('ERROR: ' + e));
}

function pollStatus() {
    fetch('/api/stats')
        .then(r => r.json())
        .then(data => {
            if (data.processing && data.processing.active) {
                updateProgress(data.processing.processed, data.processing.total);
                log(`Status: ${data.processing.processed}/${data.processing.total} processed`);
            }
            document.getElementById('queue-badge').textContent = data.queue_size;
        });
}

function refreshQueue() {
    log('Refreshing queue...');
    fetch('/api/queue')
        .then(r => r.json())
        .then(data => {
            log(`Queue now has ${data.count} items`);

            // Safely update elements that may not exist
            const badge = document.getElementById('queue-badge');
            const count = document.getElementById('queue-count');
            const tbody = document.getElementById('queue-body');

            if (badge) badge.textContent = data.count;
            if (count) count.textContent = data.count;

            if (data.count === 0) {
                // Show empty state - only reload if we had items before
                if (tbody && tbody.children.length > 0) {
                    location.reload();
                }
            } else if (tbody) {
                // Update table
                tbody.innerHTML = '';
                data.items.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.id = `queue-${item.id}`;
                    const authorEsc = escapeHtml(item.current_author);
                    const titleEsc = escapeHtml(item.current_title);
                    const issueFormatted = formatIssue(item.reason || 'Unknown');
                    tr.innerHTML = `
                        <td><span class="text-warning">${authorEsc}</span></td>
                        <td>${titleEsc}</td>
                        <td>
                            <small class="badge bg-danger text-wrap" style="max-width: 200px;" title="${escapeHtml(item.reason || 'Unknown')}">
                                ${issueFormatted}
                            </small>
                        </td>
                        <td><small>${item.added_at ? item.added_at.substring(0,16) : 'Unknown'}</small></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editItem(${item.id}, '${authorEsc.replace(/'/g, "\\'")}', '${titleEsc.replace(/'/g, "\\'")}', '${escapeHtml(item.path || '').replace(/'/g, "\\'")}')" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="removeFromQueue(${item.id})" title="Mark as OK">
                                <i class="bi bi-check"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        })
        .catch(e => log('ERROR refreshing: ' + e));
}

function removeFromQueue(queueId) {
    if (!confirm('Mark this as OK? It will be removed from queue.')) return;

    const row = document.getElementById(`queue-${queueId}`);
    if (row) {
        row.style.transition = 'opacity 0.3s';
        row.style.opacity = '0';
    }

    fetch(`/api/remove_from_queue/${queueId}`, {method: 'POST'})
        .then(r => r.json())
        .then(() => {
            log(`Removed item ${queueId} from queue`);
            if (row) {
                setTimeout(() => {
                    row.remove();
                    // Update badge count
                    const badge = document.getElementById('queue-badge');
                    if (badge) {
                        const current = parseInt(badge.textContent) || 0;
                        badge.textContent = Math.max(0, current - 1);
                    }
                    const filterCount = document.getElementById('queue-filter-count');
                    if (filterCount) {
                        const current = parseInt(filterCount.textContent) || 0;
                        filterCount.textContent = Math.max(0, current - 1);
                    }
                }, 300);
            }
            showSuccess('Removed from queue', 'Removed');
        })
        .catch(e => {
            if (row) {
                row.style.opacity = '1';
            }
            showErrorWithHelp('Error: ' + e, 'api');
        });
}

// Quick preview
function showQuickPreview(bookId) {
    // Show a tooltip or small popover with book details
    // For now, just log - can be enhanced later
    console.log('Preview book:', bookId);
}

function hideQuickPreview() {
    // Hide preview
}

// Real-time filtering for queue
function liveFilterQueue(query) {
    const rows = document.querySelectorAll('#queue-body tr');
    const lowerQuery = query.toLowerCase();
    let visibleCount = 0;
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        if (text.includes(lowerQuery)) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    // Update count
    const countEl = document.getElementById('queue-filter-count');
    if (countEl) {
        countEl.textContent = visibleCount;
    }
}

// Auto-refresh every 10 seconds
setInterval(refreshQueue, 10000);
log('Queue page loaded. Auto-refresh every 10s.');

// Fetch and display BookBucket database stats
function formatNumber(n) {
    if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
    if (n >= 1000) return (n / 1000).toFixed(0) + 'K';
    return n.toString();
}

fetch('/api/bookdb_stats')
    .then(r => r.json())
    .then(data => {
        if (data.books && data.authors && data.series) {
            const statsText = `${formatNumber(data.books)}+ books, ${formatNumber(data.series)}+ series, ${formatNumber(data.authors)}+ authors`;
            const el = document.getElementById('db-stats-text');
            if (el) el.textContent = statsText;
        }
    })
    .catch(e => console.log('Stats fetch error:', e));

// ===== EDIT FUNCTIONS =====
let selectedBookDBResult = null;
let editModal = null;

function editItem(queueId, author, title, path) {
    document.getElementById('edit-queue-id').value = queueId;
    document.getElementById('edit-author').value = author;
    document.getElementById('edit-title').value = title;
    document.getElementById('edit-current-path').textContent = path || 'Unknown';
    document.getElementById('search-query').value = title;  // Pre-fill search with title
    document.getElementById('quick-match-query').value = title;  // Pre-fill quick match
    document.getElementById('search-results').style.display = 'none';
    document.getElementById('selected-match').classList.add('d-none');
    document.getElementById('field-selection').classList.add('d-none');
    document.getElementById('path-preview').classList.add('d-none');
    document.getElementById('audnexus-result').style.display = 'none';
    document.getElementById('quick-match-result').style.display = 'none';
    selectedBookDBResult = null;
    window._audnexusResult = null;
    
    // Switch to manual tab
    const manualTab = document.getElementById('manual-tab');
    if (manualTab) {
        manualTab.click();
    }

    if (!editModal) {
        editModal = new bootstrap.Modal(document.getElementById('editModal'));
    }
    editModal.show();
    
    // Update preview when fields change
    const authorInput = document.getElementById('edit-author');
    const titleInput = document.getElementById('edit-title');
    if (authorInput && titleInput) {
        // Remove existing listeners to avoid duplicates
        const newAuthorInput = authorInput.cloneNode(true);
        const newTitleInput = titleInput.cloneNode(true);
        authorInput.parentNode.replaceChild(newAuthorInput, authorInput);
        titleInput.parentNode.replaceChild(newTitleInput, titleInput);
        
        document.getElementById('edit-author').addEventListener('input', updatePathPreview);
        document.getElementById('edit-title').addEventListener('input', updatePathPreview);
    }
    
    // Reset field selection checkboxes
    const fieldChecks = ['field-author', 'field-title', 'field-series', 'field-series-position', 'field-narrator', 'field-year', 'field-description', 'field-cover'];
    fieldChecks.forEach(id => {
        const checkbox = document.getElementById(id);
        if (checkbox) {
            // Author and title checked by default, others unchecked
            checkbox.checked = (id === 'field-author' || id === 'field-title');
        }
    });
    
    log(`Editing item ${queueId}: ${author} - ${title} (${path})`);
}

function updatePathPreview() {
    const author = document.getElementById('edit-author').value.trim();
    const title = document.getElementById('edit-title').value.trim();
    const currentPath = document.getElementById('edit-current-path').textContent;
    const previewDiv = document.getElementById('path-preview');
    
    if (!author || !title) {
        previewDiv.classList.add('d-none');
        return;
    }
    
    // Show current path
    document.getElementById('preview-old-path').textContent = currentPath;
    
    // For now, show a simple preview (full path building would require API call)
    // We'll update this when user clicks Apply Now
    const simplePreview = `${author}/${title}`;
    document.getElementById('preview-new-path').textContent = simplePreview + ' (preview)';
    previewDiv.classList.remove('d-none');
}

function saveAsPending() {
    saveManualMatch();
}

function applyDirectly() {
    const queueId = document.getElementById('edit-queue-id').value;
    const author = document.getElementById('edit-author').value.trim();
    const title = document.getElementById('edit-title').value.trim();
    
    if (!author || !title) {
        showWarning('Author and title are required.', 'Required Fields');
        return;
    }
    
    // Get book_id from queue item in the table
    const queueRow = document.getElementById(`queue-${queueId}`);
    if (!queueRow) {
        showError('Could not find queue item');
        return;
    }
    
    // Get book_id from data attribute
    const bookId = queueRow.dataset.bookId;
    if (!bookId) {
        showError('Could not find book ID for queue item');
        return;
    }
    
    proceedWithDirectApply(bookId, author, title);
}

function proceedWithDirectApply(bookId, author, title) {
    const currentPath = document.getElementById('edit-current-path').textContent;
    
    // Show preview
    document.getElementById('preview-old-path').textContent = currentPath;
    document.getElementById('preview-new-path').textContent = `${author}/${title}`;
    document.getElementById('path-preview').classList.remove('d-none');
    
    // Confirm with preview
    if (!confirm(`Apply this fix now?\n\nCurrent: ${currentPath}\nNew: ${author}/${title}\n\nThe folder will be renamed immediately.`)) {
        return;
    }
    
    const btn = document.getElementById('apply-directly-btn');
    const originalHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Applying...';
    
    const payload = {
        book_id: parseInt(bookId),
        author: author,
        title: title
    };
    
    // Include metadata result if one was selected
    if (selectedBookDBResult) {
        payload.metadata_result = selectedBookDBResult;
    } else if (window._audnexusResult) {
        payload.metadata_result = window._audnexusResult;
    }
    
    fetch('/api/apply_fix_direct', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(data => {
        btn.disabled = false;
        btn.innerHTML = originalHtml;
        
        if (data.success) {
            showSuccess('Fix applied successfully!', 'Applied');
            if (editModal) editModal.hide();
            setTimeout(() => location.reload(), 1000);
        } else {
            showErrorWithHelp(data.error || 'Unknown error', 'file');
        }
    })
    .catch(e => {
        btn.disabled = false;
        btn.innerHTML = originalHtml;
        showErrorWithHelp('Error: ' + e, 'api');
    });
}

function searchAudnexusASIN() {
    const asin = document.getElementById('audnexus-asin').value.trim().toUpperCase();
    const region = document.getElementById('audnexus-region').value;
    const resultDiv = document.getElementById('audnexus-result');
    const resultContent = document.getElementById('audnexus-result-content');
    const searchBtn = document.getElementById('search-audnexus-btn');
    
    if (!asin) {
        showWarning('Please enter an ASIN', 'ASIN Required');
        return;
    }
    
    // Validate ASIN format
    if (!/^[B0-9][A-Z0-9]{9}$/.test(asin)) {
        showError('Invalid ASIN format. ASIN must be exactly 10 alphanumeric characters (e.g., B002V5H8FK)', 'Invalid ASIN');
        return;
    }
    
    // Show loading state
    searchBtn.disabled = true;
    resultContent.innerHTML = '<div class="text-center py-2 text-muted"><div class="spinner-border spinner-border-sm me-2"></div>Looking up ASIN...</div>';
    resultDiv.style.display = 'block';
    
    const searchUrl = `/api/search_audnexus_asin?asin=${encodeURIComponent(asin)}&region=${encodeURIComponent(region)}`;
    
    // Add timeout to prevent hanging (30 seconds max)
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 30000);
    
    fetch(searchUrl, { signal: controller.signal })
        .then(r => {
            clearTimeout(timeoutId);
            return r.json();
        })
        .then(data => {
            searchBtn.disabled = false;
            
            if (data.error) {
                resultContent.innerHTML = `<div class="alert alert-danger">${escapeHtml(data.error)}</div>`;
                return;
            }
            
            if (!data.success || !data.result) {
                resultContent.innerHTML = `<div class="alert alert-warning">${escapeHtml(data.error || 'No book found for this ASIN')}</div>`;
                return;
            }
            
            const book = data.result;
            const sourceName = book.source === 'audimeta' ? 'AudiMeta' : 'Audnexus';
            const sourceColor = book.source === 'audimeta' ? 'success' : 'primary';
            const series = book.series ? ` (${book.series}${book.series_position ? ' #' + book.series_position : ''})` : '';
            const year = book.year ? ` <span class="text-muted">(${book.year})</span>` : '';
            const narrator = book.narrator ? ` <small class="text-info">Narrated by ${book.narrator}</small>` : '';
            const regionNote = data.note ? `<div class="text-warning small mb-2"><i class="bi bi-info-circle"></i> ${escapeHtml(data.note)}</div>` : '';
            
            resultContent.innerHTML = `
                ${regionNote}
                <div class="list-group">
                    <a href="#" class="list-group-item list-group-item-action bg-dark text-light"
                       onclick="selectAudnexusResult(); return false;">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="fw-bold">${escapeHtml(book.title)}</div>
                                <div class="text-info">${escapeHtml(book.author)}${year}</div>
                                ${series ? `<div class="text-warning small">${escapeHtml(series)}</div>` : ''}
                                ${narrator}
                                <div class="text-muted small mt-1">
                                    <i class="bi bi-upc"></i> ASIN: ${escapeHtml(book.asin || asin)} | 
                                    <i class="bi bi-globe"></i> Region: ${data.region.toUpperCase()} |
                                    <i class="bi bi-database"></i> Source: ${sourceName}
                                </div>
                            </div>
                            <span class="badge bg-${sourceColor} ms-2">${sourceName}</span>
                        </div>
                    </a>
                </div>
            `;
            
            // Store result for selection
            window._audnexusResult = book;
            
            log(`${sourceName} found: ${book.author} - ${book.title} (ASIN: ${book.asin || asin})`);
        })
        .catch(e => {
            clearTimeout(timeoutId);
            searchBtn.disabled = false;
            let errorMsg = 'Unknown error';
            if (e.name === 'AbortError') {
                errorMsg = 'Request timed out after 30 seconds. The ASIN may not be available or the service may be slow.';
            } else {
                errorMsg = e.toString();
            }
            resultContent.innerHTML = `<div class="alert alert-danger">Error: ${escapeHtml(errorMsg)}</div>`;
            log('Audnexus ASIN lookup error: ' + errorMsg);
        });
}

function selectAudnexusResult() {
    if (!window._audnexusResult) {
        return;
    }
    
    const book = window._audnexusResult;
    const sourceName = book.source === 'audimeta' ? 'AudiMeta' : 'Audnexus';
    
    // Apply field selection if checkboxes are checked
    if (document.getElementById('field-author')?.checked && book.author) {
        document.getElementById('edit-author').value = book.author;
    }
    if (document.getElementById('field-title')?.checked && book.title) {
        document.getElementById('edit-title').value = book.title;
    }
    if (document.getElementById('field-series')?.checked && book.series) {
        document.getElementById('edit-series').value = book.series;
    }
    if (document.getElementById('field-series-position')?.checked && book.series_position) {
        document.getElementById('edit-series-position').value = book.series_position;
    }
    if (document.getElementById('field-narrator')?.checked && book.narrator) {
        document.getElementById('edit-narrator').value = book.narrator;
    }
    
    // Store selected result (use same format as BookBucket for compatibility)
    selectedBookDBResult = {
        author_name: book.author,
        name: book.title,
        title: book.title,
        series_name: book.series,
        series_position: book.series_position,
        year_published: book.year,
        narrator: book.narrator,
        source: book.source || 'audnexus',
        asin: book.asin
    };
    
    // Show selected match
    const matchDiv = document.getElementById('selected-match');
    const matchText = document.getElementById('selected-match-text');
    const series = book.series ? ` (${book.series}${book.series_position ? ' #' + book.series_position : ''})` : '';
    matchText.textContent = `${book.author || 'Unknown'} - ${book.title || 'Unknown'}${series} [${sourceName}]`;
    matchDiv.classList.remove('d-none');
    
    // Show field selection panel
    document.getElementById('field-selection').classList.remove('d-none');
    
    // Switch to manual tab to show the filled fields
    const manualTab = document.getElementById('manual-tab');
    if (manualTab) {
        manualTab.click();
    }
    
    // Hide search results
    document.getElementById('audnexus-result').style.display = 'none';
    
    log(`Selected from ${sourceName}: ${book.author} - ${book.title}`);
}

function searchAllAPIs() {
    const query = document.getElementById('search-query').value.trim();
    const author = document.getElementById('edit-author').value.trim();
    
    if (query.length < 2) {
        showWarning('Search query must be at least 2 characters long.', 'Search Too Short');
        return;
    }

    const resultsDiv = document.getElementById('search-results');
    const resultsList = document.getElementById('search-results-list');
    const statusDiv = document.getElementById('search-status');
    const statusText = document.getElementById('search-status-text');
    const searchBtn = document.getElementById('search-all-apis-btn');
    
    // Show loading state
    statusDiv.classList.remove('d-none');
    statusText.textContent = 'Searching all APIs...';
    searchBtn.disabled = true;
    resultsList.innerHTML = '<div class="text-center py-3 text-muted">Searching Audnexus, OpenLibrary, Google Books, Hardcover, and BookBucket...</div>';
    resultsDiv.style.display = 'block';

    const searchUrl = `/api/search_all_apis?q=${encodeURIComponent(query)}${author ? '&author=' + encodeURIComponent(author) : ''}`;
    
    fetch(searchUrl)
        .then(r => r.json())
        .then(data => {
            statusDiv.classList.add('d-none');
            searchBtn.disabled = false;
            
            if (data.error) {
                resultsList.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                return;
            }

            if (!data.results_by_source || Object.keys(data.results_by_source).length === 0) {
                resultsList.innerHTML = '<div class="alert alert-warning">No results found from any API. Try a different search term.</div>';
                return;
            }

            // Group results by source
            let html = '';
            const sourceColors = {
                'Audnexus': 'info',
                'OpenLibrary': 'primary',
                'Google Books': 'success',
                'Hardcover': 'warning',
                'BookBucket': 'secondary'
            };
            
            for (const [source, results] of Object.entries(data.results_by_source)) {
                const color = sourceColors[source] || 'secondary';
                html += `
                    <div class="mb-3">
                        <h6 class="text-${color} mb-2">
                            <i class="bi bi-database"></i> ${source} 
                            <span class="badge bg-${color}">${results.length}</span>
                        </h6>
                        <div class="list-group">
                `;
                
                results.forEach((book, idx) => {
                    const bookId = `all-apis-${source}-${idx}`;
                    const series = book.series ? ` (${book.series}${book.series_position ? ' #' + book.series_position : ''})` : '';
                    const year = book.year ? ` <span class="text-muted">(${book.year})</span>` : '';
                    const narrator = book.narrator ? ` <small class="text-info">Narrated by ${book.narrator}</small>` : '';
                    
                    html += `
                        <a href="#" class="list-group-item list-group-item-action bg-dark text-light search-result-item"
                           data-book-id="${bookId}"
                           data-source="${source}"
                           onclick="selectAPIResult('${source}', ${idx}); return false;">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <div class="fw-bold">${escapeHtml(book.title)}</div>
                                    <div class="text-info">${escapeHtml(book.author)}${year}</div>
                                    ${series ? `<div class="text-warning small">${escapeHtml(series)}</div>` : ''}
                                    ${narrator}
                                </div>
                                <span class="badge bg-${color} ms-2">${source}</span>
                            </div>
                        </a>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            html += `<div class="text-muted small mt-2">Found ${data.total_count} result(s) across ${Object.keys(data.results_by_source).length} source(s)</div>`;
            
            resultsList.innerHTML = html;
            
            // Store results for selection
            window._allAPIResults = data.results_by_source;
            
            log(`Found ${data.total_count} results from ${Object.keys(data.results_by_source).length} APIs`);
        })
        .catch(e => {
            statusDiv.classList.add('d-none');
            searchBtn.disabled = false;
            resultsList.innerHTML = `<div class="alert alert-danger">Error: ${e}</div>`;
            log('Search all APIs error: ' + e);
        });
}

function selectAPIResult(source, idx) {
    if (!window._allAPIResults || !window._allAPIResults[source] || !window._allAPIResults[source][idx]) {
        return;
    }
    
    const book = window._allAPIResults[source][idx];
    
    // Apply field selection if checkboxes are checked
    if (document.getElementById('field-author')?.checked && book.author) {
        document.getElementById('edit-author').value = book.author;
    }
    if (document.getElementById('field-title')?.checked && book.title) {
        document.getElementById('edit-title').value = book.title;
    }
    if (document.getElementById('field-series')?.checked && book.series) {
        document.getElementById('edit-series').value = book.series;
    }
    if (document.getElementById('field-series-position')?.checked && book.series_position) {
        document.getElementById('edit-series-position').value = book.series_position;
    }
    if (document.getElementById('field-narrator')?.checked && book.narrator) {
        document.getElementById('edit-narrator').value = book.narrator;
    }
    
    // Store selected result (use same format as BookBucket for compatibility)
    selectedBookDBResult = {
        author_name: book.author,
        name: book.title,
        title: book.title,
        series_name: book.series,
        series_position: book.series_position,
        year_published: book.year,
        narrator: book.narrator,
        source: book.source || source
    };
    
    // Show selected match
    const matchDiv = document.getElementById('selected-match');
    const matchText = document.getElementById('selected-match-text');
    const series = book.series ? ` (${book.series}${book.series_position ? ' #' + book.series_position : ''})` : '';
    matchText.textContent = `${book.author || 'Unknown'} - ${book.title || 'Unknown'}${series} [${source}]`;
    matchDiv.classList.remove('d-none');
    
    // Show field selection panel
    document.getElementById('field-selection').classList.remove('d-none');
    
    // Switch to manual tab to show the filled fields
    const manualTab = document.getElementById('manual-tab');
    if (manualTab) {
        manualTab.click();
    }
    
    // Hide search results
    document.getElementById('search-results').style.display = 'none';
    
    log(`Selected from ${source}: ${book.author} - ${book.title}`);
}

function searchBookDB() {
    const query = document.getElementById('search-query').value.trim();
    if (query.length < 2) {
        showWarning('Search query must be at least 2 characters long.', 'Search Too Short');
        return;
    }

    const resultsDiv = document.getElementById('search-results');
    const resultsList = document.getElementById('search-results-list');
    resultsList.innerHTML = '<div class="list-group-item bg-dark text-muted">Searching...</div>';
    resultsDiv.style.display = 'block';

    fetch(`/api/search_bookdb?q=${encodeURIComponent(query)}&limit=20`)
        .then(r => r.json())
        .then(data => {
            if (data.error) {
                resultsList.innerHTML = `<div class="list-group-item bg-dark text-danger">${data.error}</div>`;
                return;
            }

            if (!data.results || data.results.length === 0) {
                resultsList.innerHTML = '<div class="list-group-item bg-dark text-muted">No results found</div>';
                return;
            }

            resultsList.innerHTML = '<div class="mb-2"><h6 class="text-secondary"><i class="bi bi-database"></i> BookBucket Results</h6></div><div class="list-group">' + data.results.map((book, idx) => {
                const author = book.author_name || 'Unknown Author';
                const title = book.name || book.title || 'Unknown Title';
                const series = book.series_name ? `${book.series_name}${book.series_position ? ' #' + book.series_position : ''}` : '';
                const year = book.year_published ? book.year_published : '';
                const isbn = book.isbn || '';
                const bookId = book.id || 0;
                const coverUrl = book.cover_url;
                const completeness = book.completeness || 0;
                const missingFields = book.missing_fields || [];

                // Completeness badge color based on score
                let completenessColor = 'danger';
                let completenessIcon = 'exclamation-triangle';
                if (completeness >= 80) {
                    completenessColor = 'success';
                    completenessIcon = 'check-circle';
                } else if (completeness >= 60) {
                    completenessColor = 'info';
                    completenessIcon = 'info-circle';
                } else if (completeness >= 40) {
                    completenessColor = 'warning';
                    completenessIcon = 'exclamation-circle';
                }

                // Create missing fields tooltip
                const missingTooltip = missingFields.length > 0
                    ? `Missing: ${missingFields.join(', ')}`
                    : 'Complete metadata';

                // Create cover thumbnail HTML
                const coverHtml = coverUrl
                    ? `<img src="${coverUrl}" alt="" class="search-result-cover" onerror="this.parentElement.innerHTML='<div class=\\'search-cover-placeholder\\'><i class=\\'bi bi-book\\'></i></div>'">`
                    : `<div class="search-cover-placeholder"><i class="bi bi-book"></i></div>`;

                return `
                    <a href="#" class="list-group-item list-group-item-action bg-dark text-light search-result-item"
                       data-book-id="${bookId}"
                       data-idx="${idx}"
                       onmouseenter="showHoverCard(event, ${bookId})"
                       onmouseleave="hideHoverCard()"
                       onclick="selectResult(${idx}); return false;">
                        <div class="d-flex align-items-start gap-2">
                            <div class="search-cover-container">${coverHtml}</div>
                            <div class="flex-grow-1" style="min-width: 0;">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="fw-bold text-truncate" style="flex: 1;">${escapeHtml(title)}</div>
                                    <span class="badge bg-${completenessColor} ms-2" title="${missingTooltip}" style="font-size: 0.65rem;">
                                        <i class="bi bi-${completenessIcon}"></i> ${completeness}%
                                    </span>
                                </div>
                                <div class="text-info small">${escapeHtml(author)}</div>
                                ${series ? `<div class="text-warning small">${escapeHtml(series)}</div>` : ''}
                                <div class="d-flex gap-2 small text-muted mt-1">
                                    ${year ? `<span><i class="bi bi-calendar"></i> ${year}</span>` : ''}
                                    ${isbn ? `<span><i class="bi bi-upc"></i> ${isbn}</span>` : ''}
                                </div>
                            </div>
                        </div>
                    </a>
                `;
            }).join('') + '</div>';

            // Store results for selection (for compatibility with existing code)
            window._searchResults = data.results;
            log(`Found ${data.results.length} BookBucket results for "${query}"`);
        })
        .catch(e => {
            resultsList.innerHTML = `<div class="list-group-item bg-dark text-danger">Error: ${e}</div>`;
            log('Search error: ' + e);
        });
}

function selectResult(idx) {
    const book = window._searchResults[idx];
    if (!book) return;

    selectedBookDBResult = book;

    // Fill in the form fields
    if (book.author_name) {
        document.getElementById('edit-author').value = book.author_name;
    }
    if (book.name || book.title) {
        document.getElementById('edit-title').value = book.name || book.title;
    }

    // Show selected match
    const matchDiv = document.getElementById('selected-match');
    const matchText = document.getElementById('selected-match-text');
    const series = book.series_name ? ` (${book.series_name}${book.series_position ? ' #' + book.series_position : ''})` : '';
    matchText.textContent = `${book.author_name || 'Unknown'} - ${book.name || book.title || 'Unknown'}${series}`;
    matchDiv.classList.remove('d-none');

    // Hide search results
    document.getElementById('search-results').style.display = 'none';

    log(`Selected: ${book.author_name} - ${book.name || book.title}`);
}

function clearSelection() {
    selectedBookDBResult = null;
    window._audnexusResult = null;
    document.getElementById('selected-match').classList.add('d-none');
    document.getElementById('field-selection').classList.add('d-none');
}

function quickMatch() {
    const query = document.getElementById('quick-match-query').value.trim();
    const author = document.getElementById('edit-author').value.trim();
    const title = document.getElementById('edit-title').value.trim();
    
    // Use existing title/author if query is empty
    const searchQuery = query || (title ? `${author ? author + ' - ' : ''}${title}` : '');
    
    if (!searchQuery || searchQuery.length < 2) {
        showWarning('Please enter a search query or fill in author/title fields.', 'Search Required');
        return;
    }
    
    const btn = document.getElementById('quick-match-btn');
    const resultDiv = document.getElementById('quick-match-result');
    const resultContent = document.getElementById('quick-match-result-content');
    const originalHtml = btn.innerHTML;
    
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Matching...';
    resultContent.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm text-primary me-2"></div>Searching all providers...</div>';
    resultDiv.style.display = 'block';
    
    // Search all APIs
    const searchUrl = `/api/search_all_apis?q=${encodeURIComponent(searchQuery)}${author ? '&author=' + encodeURIComponent(author) : ''}`;
    
    fetch(searchUrl)
        .then(r => r.json())
        .then(data => {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
            
            if (data.error || !data.results_by_source || Object.keys(data.results_by_source).length === 0) {
                resultContent.innerHTML = '<div class="alert alert-warning">No results found. Try manual search or ASIN lookup.</div>';
                return;
            }
            
            // Find best match (first result from most reliable source)
            // Priority: BookBucket > Google Books > OpenLibrary > Hardcover
            const priority = ['BookBucket', 'Google Books', 'OpenLibrary', 'Hardcover'];
            let bestMatch = null;
            let bestSource = null;
            
            for (const source of priority) {
                if (data.results_by_source[source] && data.results_by_source[source].length > 0) {
                    bestMatch = data.results_by_source[source][0];
                    bestSource = source;
                    break;
                }
            }
            
            // If no priority source, use first available
            if (!bestMatch) {
                const firstSource = Object.keys(data.results_by_source)[0];
                bestMatch = data.results_by_source[firstSource][0];
                bestSource = firstSource;
            }
            
            if (bestMatch) {
                // Auto-select the best match
                selectedBookDBResult = {
                    author_name: bestMatch.author,
                    name: bestMatch.title,
                    title: bestMatch.title,
                    series_name: bestMatch.series,
                    series_position: bestMatch.series_position,
                    year_published: bestMatch.year,
                    source: bestSource
                };
                
                // Fill in fields
                if (bestMatch.author) {
                    document.getElementById('edit-author').value = bestMatch.author;
                }
                if (bestMatch.title) {
                    document.getElementById('edit-title').value = bestMatch.title;
                }
                if (bestMatch.series) {
                    document.getElementById('edit-series').value = bestMatch.series;
                }
                if (bestMatch.series_position) {
                    document.getElementById('edit-series-position').value = bestMatch.series_position;
                }
                
                // Show success
                const series = bestMatch.series ? ` (${bestMatch.series}${bestMatch.series_position ? ' #' + bestMatch.series_position : ''})` : '';
                resultContent.innerHTML = `
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle"></i> <strong>Quick Match Found!</strong><br>
                        ${escapeHtml(bestMatch.author || 'Unknown')} - ${escapeHtml(bestMatch.title || 'Unknown')}${series}<br>
                        <small class="text-muted">Source: ${bestSource} | Confidence: High</small>
                    </div>
                    <div class="mt-2">
                        <button class="btn btn-sm btn-primary" onclick="switchToManualTab()">
                            <i class="bi bi-pencil"></i> Review & Edit
                        </button>
                    </div>
                `;
                
                // Show selected match
                const matchDiv = document.getElementById('selected-match');
                const matchText = document.getElementById('selected-match-text');
                matchText.textContent = `${bestMatch.author || 'Unknown'} - ${bestMatch.title || 'Unknown'}${series} [${bestSource}]`;
                matchDiv.classList.remove('d-none');
                
                // Switch to manual tab
                setTimeout(() => {
                    const manualTab = document.getElementById('manual-tab');
                    if (manualTab) manualTab.click();
                }, 500);
                
                log(`Quick Match: ${bestMatch.author} - ${bestMatch.title} from ${bestSource}`);
            } else {
                resultContent.innerHTML = '<div class="alert alert-warning">No suitable match found. Try manual search.</div>';
            }
        })
        .catch(e => {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
            resultContent.innerHTML = `<div class="alert alert-danger">Error: ${escapeHtml(e.toString())}</div>`;
        });
}

function switchToManualTab() {
    const manualTab = document.getElementById('manual-tab');
    if (manualTab) {
        manualTab.click();
    }
}

function saveManualMatch() {
    const queueId = document.getElementById('edit-queue-id').value;
    const author = document.getElementById('edit-author').value.trim();
    const title = document.getElementById('edit-title').value.trim();

    if (!author || !title) {
        showWarning('Author and title are required to save a match.', 'Required Fields');
        return;
    }

    const payload = {
        queue_id: parseInt(queueId),
        author: author,
        title: title
    };

    // Include BookDB result if one was selected
    if (selectedBookDBResult) {
        payload.bookdb_result = selectedBookDBResult;
    }

    fetch('/api/manual_match', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            log(`Saved: ${data.message}`);
            editModal.hide();
            document.getElementById(`queue-${queueId}`).remove();
            refreshQueue();
            showSuccess('Saved as pending fix! Go to History > Pending to apply it.', 'Saved', null, null, {url: '/history?status=pending', text: 'View Pending Fixes'});
        } else {
            showErrorWithHelp(data.error || 'Unknown error', 'database');
            log('Save error: ' + data.error);
        }
    })
    .catch(e => {
        showErrorWithHelp('Error: ' + e, 'api');
        log('Save error: ' + e);
    });
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ===== HOVER CARD FUNCTIONS =====
let hoverTimeout = null;
let hoverCardVisible = false;
let cachedBookDetails = {};  // Cache to avoid repeated API calls
let currentHoverBookId = null;
let detailModal = null;
let currentDetailBook = null;

function showHoverCard(event, bookId) {
    if (!bookId) return;
    currentHoverBookId = bookId;

    // Clear any pending hide
    if (hoverTimeout) {
        clearTimeout(hoverTimeout);
        hoverTimeout = null;
    }

    // Position the card
    const card = document.getElementById('book-hover-card');
    const rect = event.target.getBoundingClientRect();

    // Position to the right of the item, or left if not enough space
    let left = rect.right + 10;
    if (left + 400 > window.innerWidth) {
        left = rect.left - 390;
    }

    card.style.left = left + 'px';
    card.style.top = Math.max(10, rect.top - 50) + 'px';

    // Show loading state
    document.getElementById('hover-title').textContent = 'Loading...';
    document.getElementById('hover-author').textContent = '';
    document.getElementById('hover-series').textContent = '';
    document.getElementById('hover-meta').textContent = '';
    document.getElementById('hover-description').textContent = '';
    document.getElementById('hover-tags').innerHTML = '';
    document.getElementById('hover-abs-status').style.display = 'none';
    document.getElementById('hover-cover-container').innerHTML = '<div class="book-cover-placeholder"><i class="bi bi-book"></i></div>';

    card.classList.add('show');
    hoverCardVisible = true;

    // Check cache first
    if (cachedBookDetails[bookId]) {
        renderHoverCard(cachedBookDetails[bookId]);
        return;
    }

    // Fetch book details
    fetch(`/api/book_detail/${bookId}`)
        .then(r => r.json())
        .then(data => {
            if (currentHoverBookId !== bookId) return;  // User moved to another item

            if (data.error) {
                document.getElementById('hover-title').textContent = 'Error loading details';
                return;
            }

            cachedBookDetails[bookId] = data;
            renderHoverCard(data);
        })
        .catch(e => {
            if (currentHoverBookId === bookId) {
                document.getElementById('hover-title').textContent = 'Failed to load';
            }
        });
}

function renderHoverCard(data) {
    const book = data.book;
    const absStatus = data.abs_status || [];

    document.getElementById('hover-title').textContent = book.name || book.title || 'Unknown Title';
    document.getElementById('hover-author').textContent = book.author_name || 'Unknown Author';

    // Series
    if (book.series_name) {
        const pos = book.series_position ? ` #${book.series_position}` : '';
        document.getElementById('hover-series').textContent = `${book.series_name}${pos}`;
    } else {
        document.getElementById('hover-series').textContent = '';
    }

    // Meta line (year, pages, language)
    let meta = [];
    if (book.year_published) meta.push(book.year_published);
    if (book.page_count) meta.push(`${book.page_count} pages`);
    if (book.language && book.language !== 'eng') meta.push(book.language);
    if (book.publisher) meta.push(book.publisher);
    document.getElementById('hover-meta').textContent = meta.join(' Â· ');

    // Description (truncated)
    const desc = book.description || '';
    document.getElementById('hover-description').textContent = desc.length > 200 ? desc.substring(0, 200) + '...' : desc;

    // Cover
    if (book.cover_url) {
        document.getElementById('hover-cover-container').innerHTML = `<img src="${book.cover_url}" class="book-cover" alt="Cover" onerror="this.outerHTML='<div class=\\'book-cover-placeholder\\'><i class=\\'bi bi-book\\'></i></div>'">`;
    }

    // Tags (subjects)
    const tagsContainer = document.getElementById('hover-tags');
    if (book.subjects) {
        const subjects = book.subjects.split(',').slice(0, 5);
        tagsContainer.innerHTML = subjects.map(s => `<span class="book-tag">${escapeHtml(s.trim())}</span>`).join('');
    } else {
        tagsContainer.innerHTML = '';
    }

    // ABS Status
    const absSection = document.getElementById('hover-abs-status');
    const absUsersDiv = document.getElementById('hover-abs-users');
    if (absStatus.length > 0) {
        absSection.style.display = 'block';
        absUsersDiv.innerHTML = absStatus.map(u => {
            const icon = u.is_finished ? 'âœ…' : 'ðŸŽ§';
            const pct = u.progress + '%';
            return `<div class="abs-user">
                <span>${icon}</span>
                <span>${escapeHtml(u.username)}</span>
                <div class="progress">
                    <div class="progress-bar ${u.is_finished ? 'bg-success' : 'bg-info'}" style="width: ${u.progress}%"></div>
                </div>
                <span class="text-muted">${pct}</span>
            </div>`;
        }).join('');
    } else {
        absSection.style.display = 'none';
    }
}

function hideHoverCard() {
    // Delay hiding to allow moving to the card
    hoverTimeout = setTimeout(() => {
        const card = document.getElementById('book-hover-card');
        card.classList.remove('show');
        hoverCardVisible = false;
        currentHoverBookId = null;
    }, 200);
}

// Keep card visible when hovering over the card itself
document.getElementById('book-hover-card').addEventListener('mouseenter', () => {
    if (hoverTimeout) {
        clearTimeout(hoverTimeout);
        hoverTimeout = null;
    }
});

document.getElementById('book-hover-card').addEventListener('mouseleave', () => {
    hideHoverCard();
});

// ===== DETAIL MODAL FUNCTIONS =====
function showBookDetail(bookId) {
    if (!detailModal) {
        detailModal = new bootstrap.Modal(document.getElementById('bookDetailModal'));
    }

    // Reset modal
    document.getElementById('detail-title').textContent = 'Loading...';
    document.getElementById('detail-author').textContent = '';
    document.getElementById('detail-series').style.display = 'none';
    document.getElementById('detail-year-container').style.display = 'none';
    document.getElementById('detail-pages-container').style.display = 'none';
    document.getElementById('detail-language-container').style.display = 'none';
    document.getElementById('detail-isbns').style.display = 'none';
    document.getElementById('detail-subjects').innerHTML = '';
    document.getElementById('detail-description').textContent = '';
    document.getElementById('detail-abs-section').style.display = 'none';
    document.getElementById('detail-cover-container').innerHTML = '<div class="book-cover-placeholder" style="width: 150px; height: 220px; margin: auto;"><i class="bi bi-book" style="font-size: 3rem;"></i></div>';

    detailModal.show();

    // Fetch with ABS data
    fetch(`/api/book_detail/${bookId}?include_abs=true`)
        .then(r => r.json())
        .then(data => {
            if (data.error) {
                document.getElementById('detail-title').textContent = 'Error: ' + data.error;
                return;
            }

            currentDetailBook = data.book;
            renderDetailModal(data);
        })
        .catch(e => {
            document.getElementById('detail-title').textContent = 'Failed to load: ' + e;
        });
}

function renderDetailModal(data) {
    const book = data.book;
    const absStatus = data.abs_status || [];

    document.getElementById('detail-title').textContent = book.name || book.title || 'Unknown Title';
    document.getElementById('detail-author').textContent = book.author_name || 'Unknown Author';

    // Series
    if (book.series_name) {
        const pos = book.series_position ? ` #${book.series_position}` : '';
        document.getElementById('detail-series').textContent = `${book.series_name}${pos}`;
        document.getElementById('detail-series').style.display = 'block';
    }

    // Year, pages, language
    if (book.year_published) {
        document.getElementById('detail-year').textContent = book.year_published;
        document.getElementById('detail-year-container').style.display = 'block';
    }
    if (book.page_count) {
        document.getElementById('detail-pages').textContent = book.page_count;
        document.getElementById('detail-pages-container').style.display = 'block';
    }
    if (book.language) {
        document.getElementById('detail-language').textContent = book.language.toUpperCase();
        document.getElementById('detail-language-container').style.display = 'block';
    }

    // ISBN
    const isbn = book.isbn13 || book.isbn10 || book.isbn;
    if (isbn) {
        document.getElementById('detail-isbn').textContent = isbn;
        document.getElementById('detail-isbns').style.display = 'block';
    }

    // Subjects
    if (book.subjects) {
        const subjects = book.subjects.split(',').slice(0, 10);
        document.getElementById('detail-subjects').innerHTML = subjects.map(s =>
            `<span class="badge bg-secondary me-1 mb-1">${escapeHtml(s.trim())}</span>`
        ).join('');
    }

    // Description
    document.getElementById('detail-description').innerHTML = book.description ?
        `<p class="text-muted">${escapeHtml(book.description)}</p>` :
        '<p class="text-muted fst-italic">No description available</p>';

    // Cover
    if (book.cover_url) {
        document.getElementById('detail-cover-container').innerHTML = `<img src="${book.cover_url}" style="max-width: 150px; max-height: 220px; border-radius: 8px;" alt="Cover" onerror="this.outerHTML='<div class=\\'book-cover-placeholder\\' style=\\'width: 150px; height: 220px; margin: auto;\\'><i class=\\'bi bi-book\\' style=\\'font-size: 3rem;\\'></i></div>'">`;
    }

    // ABS Status
    if (absStatus.length > 0) {
        document.getElementById('detail-abs-section').style.display = 'block';
        document.getElementById('detail-abs-users').innerHTML = absStatus.map(u => {
            const icon = u.is_finished ? 'âœ… Finished' : `ðŸŽ§ ${u.progress}%`;
            return `<div class="d-flex justify-content-between align-items-center py-1">
                <span>${escapeHtml(u.username)}</span>
                <span>${icon}</span>
            </div>`;
        }).join('');
    }
}

function useBookFromDetail() {
    if (!currentDetailBook) return;

    // Find in search results
    const idx = window._searchResults?.findIndex(b => b.id === currentDetailBook.id);
    if (idx >= 0) {
        selectResult(idx);
    } else {
        // Direct fill if not in results
        document.getElementById('edit-author').value = currentDetailBook.author_name || '';
        document.getElementById('edit-title').value = currentDetailBook.name || currentDetailBook.title || '';
        selectedBookDBResult = currentDetailBook;

        const matchDiv = document.getElementById('selected-match');
        const matchText = document.getElementById('selected-match-text');
        const series = currentDetailBook.series_name ? ` (${currentDetailBook.series_name})` : '';
        matchText.textContent = `${currentDetailBook.author_name || 'Unknown'} - ${currentDetailBook.name || currentDetailBook.title || 'Unknown'}${series}`;
        matchDiv.classList.remove('d-none');
        document.getElementById('search-results').style.display = 'none';
    }

    detailModal.hide();
}
</script>
{% endblock %}
